<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<title>Arvin Controls | Fire Safety Portal</title>

<style>
:root { 
    --fire-red: #cc0000; 
    --charcoal: #1a1a1a; 
    --safety-orange: #ff6600;
    --light-bg: #f4f7f6;
    --border-color: #d1d8e0;
    --folder-bg: #ffffff;
    --accent-blue: #007aff;
    --success-green: #27ae60;
    --accounts-workorder: #e67e22;
    --accounts-income: #27ae60;
    --accounts-expense: #e74c3c;
    --accounts-transaction: #3498db;
}

* {
    -webkit-tap-highlight-color: transparent;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen-Sans, Ubuntu, Cantarell, sans-serif;
    background: var(--light-bg);
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    touch-action: manipulation;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

.container {
    width: 100%;
    min-height: 100vh;
    background: white;
}

.interface-bar {
    background: linear-gradient(135deg, #1a1a1a 0%, #333333 100%);
    padding: 18px 16px;
    color: white;
    display: flex;
    justify-content: center; 
    align-items: center;
    border-bottom: 4px solid var(--fire-red);
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.interface-bar h1 { 
    margin: 0; 
    font-size: clamp(18px, 5vw, 24px); 
    letter-spacing: 0.5px; 
    font-weight: 800;
    color: #ffffff;
    text-transform: uppercase;
    text-align: center;
    word-break: break-word;
}

/* ===== INDIVIDUAL COLOR FOR EACH TAB FOLDER - ENHANCED DECOR ===== */
.tab-nav {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 6px;
    padding: 10px;
    background: #f0f2f5;
    width: 100%;
    overflow-x: hidden;
}

@media (min-width: 480px) {
    .tab-nav { 
        grid-template-columns: repeat(4, 1fr);
        gap: 8px;
        padding: 12px;
    }
}

@media (min-width: 768px) {
    .tab-nav { 
        grid-template-columns: repeat(5, 1fr);
        gap: 10px;
        padding: 15px;
    }
    .interface-bar { 
        padding: 25px 20px;
        justify-content: flex-start; 
    }
}

@media (min-width: 1024px) {
    .tab-nav { 
        grid-template-columns: repeat(6, 1fr);
        gap: 12px;
        padding: 20px;
    }
}

.tab-link {
    aspect-ratio: 1 / 0.95;
    cursor: pointer;
    border: 1px solid rgba(0,0,0,0.05);
    background: #ffffff;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    border-radius: 8px;
    position: relative;
    padding: 10px 6px;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.04);
    -webkit-appearance: none;
    appearance: none;
    min-height: 80px;
    touch-action: manipulation;
    border-bottom: 6px solid; /* individual color will be applied inline via style in each button */
}

.tab-link:active {
    transform: translateY(1px);
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.tab-link:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 12px rgba(0,0,0,0.1);
}

.tab-link svg {
    width: clamp(24px, 6vw, 28px);
    height: clamp(24px, 6vw, 28px);
    margin-bottom: 6px;
    flex-shrink: 0;
}

.tab-link strong {
    display: block;
    color: var(--charcoal);
    font-size: clamp(11px, 3.5vw, 13px); /* ENHANCED FOR MOBILE */
    text-transform: uppercase;
    letter-spacing: 0.3px;
    font-weight: 700;
    line-height: 1.2;
    word-break: break-word;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.content-box { 
    padding: 0;
    width: 100%;
    overflow-x: hidden;
}

.tab-content { 
    display: none; 
    padding: 16px;
    animation: fadeIn 0.3s ease;
    width: 100%;
    min-height: calc(100vh - 140px);
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.btn-back {
    background: #333;
    color: white;
    border: none;
    padding: 14px 16px;
    font-size: 13px;
    font-weight: bold;
    cursor: pointer;
    margin-bottom: 20px;
    text-transform: uppercase;
    border-radius: 8px;
    width: 100%;
    touch-action: manipulation;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn-back:active {
    transform: translateY(1px);
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.btn-back::before {
    content: "‚Üê";
    font-size: 16px;
}

.form-group { 
    margin-bottom: 20px;
    width: 100%;
}

.grid-2 { 
    display: grid; 
    grid-template-columns: 1fr; 
    gap: 16px;
    width: 100%;
}

@media (min-width: 600px) {
    .grid-2 { 
        grid-template-columns: 1fr 1fr; 
        gap: 20px;
    }
    .btn-back { 
        width: auto;
        max-width: 200px;
    }
}

label { 
    display: block; 
    font-weight: 700; 
    margin-bottom: 8px; 
    color: var(--charcoal); 
    font-size: 12px; 
    letter-spacing: 0.5px; 
    text-transform: uppercase; 
    line-height: 1.4;
}

input, textarea, select { 
    width: 100%; 
    padding: 16px 14px; 
    border: 2px solid #edf0f2; 
    border-radius: 10px; 
    font-size: 16px; 
    box-sizing: border-box; 
    transition: border-color 0.2s;
    -webkit-appearance: none;
    appearance: none;
    background: #fff;
    font-family: inherit;
    touch-action: manipulation;
}

input[type="text"],
input[type="email"],
input[type="date"],
input[type="tel"] {
    font-size: 16px;
}

textarea {
    height: 120px;
    line-height: 1.6;
    resize: vertical;
    min-height: 120px;
    max-height: 300px;
}

input:focus, textarea:focus, select:focus { 
    outline: none; 
    border-color: var(--fire-red);
    box-shadow: 0 0 0 3px rgba(204, 0, 0, 0.1);
}

.btn-save { 
    background: var(--fire-red); 
    color: white; 
    padding: 18px 24px; 
    border: none; 
    border-radius: 10px; 
    cursor: pointer; 
    font-weight: bold; 
    text-transform: uppercase;
    letter-spacing: 1px; 
    width: 100%; 
    margin-top: 10px;
    font-size: 15px;
    touch-action: manipulation;
    position: relative;
    transition: all 0.2s;
    box-shadow: 0 4px 8px rgba(204, 0, 0, 0.2);
}

.btn-save:active {
    transform: translateY(2px);
    box-shadow: 0 2px 4px rgba(204, 0, 0, 0.2);
}

.btn-save:hover { 
    background: #a30000; 
}

.section-divider {
    border-bottom: 2px solid var(--fire-red);
    margin: 30px 0 20px 0;
    padding-bottom: 8px;
    color: var(--charcoal);
    font-size: 15px;
    text-transform: uppercase;
    font-weight: 700;
}

.preview-img {
    height: auto;
    max-height: 100px;
    width: auto;
    max-width: 100%;
    margin-top: 10px;
    display: block;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    object-fit: contain;
}

input[type="file"] {
    padding: 12px;
    font-size: 14px;
    border: 2px dashed var(--border-color);
    background: #f9f9f9;
}

input[type="file"]:focus {
    border-color: var(--fire-red);
    background: #fff;
}

.doc-card { 
    border: 1px solid var(--border-color); 
    padding: 20px; 
    margin-top: 20px; 
    border-left: 6px solid var(--fire-red); 
    background: #fff;
    border-radius: 10px;
    width: 100%;
    overflow-wrap: break-word;
    word-wrap: break-word;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
.doc-card h3 { 
    margin: 8px 0; 
    color: var(--charcoal); 
    font-size: 17px; 
    line-height: 1.3;
}
.doc-card p { 
    text-align: left; 
    white-space: pre-wrap; 
    color: #555; 
    font-size: 14px; 
    line-height: 1.6;
    overflow-wrap: break-word;
    word-break: break-word;
}

.btn-print { 
    background: white; 
    color: var(--fire-red); 
    border: 2px solid var(--fire-red); 
    padding: 14px 20px; 
    cursor: pointer; 
    font-weight: bold; 
    border-radius: 8px;
    transition: all 0.2s; 
    width: 100%; 
    margin-top: 15px;
    font-size: 14px;
    touch-action: manipulation;
}
.btn-print:active { 
    background: var(--fire-red); 
    color: white;
    transform: translateY(1px);
}
.btn-print:hover { 
    background: var(--fire-red); 
    color: white; 
}

.placeholder-msg {
    text-align: center;
    padding: 40px 20px;
    border: 2px dashed var(--border-color);
    color: #888;
    border-radius: 12px;
    margin: 20px 0;
    font-size: 14px;
}

.table-container { 
    width: 100%;
    overflow-x: auto;
    margin-top: 20px;
    -webkit-overflow-scrolling: touch;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

table { 
    width: 100%; 
    min-width: 600px;
    border-collapse: collapse; 
    font-size: 14px;
}

table th { 
    background: #f8f9fa; 
    text-align: left; 
    padding: 16px 12px; 
    border-bottom: 2px solid var(--fire-red); 
    text-transform: uppercase; 
    font-size: 11px; 
    font-weight: 700;
    white-space: nowrap;
    position: sticky;
    top: 0;
    z-index: 10;
}

table td { 
    padding: 16px 12px; 
    border-bottom: 1px solid #eee; 
    vertical-align: middle;
    word-break: break-word;
}

table tr:last-child td {
    border-bottom: none;
}

.action-btn { 
    padding: 8px 12px; 
    border: none; 
    border-radius: 6px; 
    cursor: pointer; 
    font-size: 11px; 
    font-weight: bold; 
    text-transform: uppercase; 
    margin-right: 5px;
    margin-bottom: 5px;
    touch-action: manipulation;
    min-width: 60px;
}

.action-btn:active {
    transform: translateY(1px);
}

.edit-btn { background: #3498db; color: white; }
.del-btn { background: #e74c3c; color: white; }
.convert-btn { background: #9b59b6; color: white; }

.add-new-btn { 
    background: var(--success-green); 
    color: white; 
    border: none; 
    padding: 14px 20px; 
    border-radius: 8px; 
    cursor: pointer; 
    font-weight: bold; 
    float: right; 
    margin-bottom: 15px;
    font-size: 14px;
    touch-action: manipulation;
    width: 100%;
    max-width: 200px;
}

@media (max-width: 480px) {
    .add-new-btn {
        float: none;
        width: 100%;
        max-width: none;
        margin-bottom: 20px;
    }
}

.modal { 
    display: none; 
    position: fixed; 
    z-index: 4000; 
    left: 0; 
    top: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(0,0,0,0.7); 
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    overflow-y: auto;
    padding: 20px 10px;
}

.modal-content { 
    background: white; 
    margin: 10px auto; 
    padding: 25px 20px; 
    width: 95%; 
    max-width: 500px; 
    border-radius: 12px; 
    position: relative;
    max-height: 90vh;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
}

.close-modal { 
    position: absolute; 
    right: 20px; 
    top: 15px; 
    font-size: 28px; 
    cursor: pointer; 
    color: #999;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
}

::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}

::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
    background: #555;
}

#print-area { display: none; }

@media print {
    @page { size: A4; margin: 6mm 8mm 6mm 8mm; } 
    body { background: white; padding: 0; margin: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    #main-ui, .modal { display: none !important; }
    #print-area { display: block !important; width: 100%; }
    .print-table { width: 100%; border-collapse: collapse; }
    thead { display: table-header-group; }
    .header-space { height: 15mm; }
    .header-content { 
        position: fixed; top: 0; width: 100%; 
        background: white; z-index: 1000; padding-top: 1mm;
    }
    tfoot { display: table-footer-group; }
    .footer-space { height: 10mm; } 
    .footer-content { 
        position: fixed; bottom: 0; width: 100%; height: 10mm; 
        background: white; text-align: center; z-index: 1000;
    }
    .pdf-header-wrapper { 
        border-bottom: 3px solid var(--fire-red); 
        padding-bottom: 2px; 
        text-align: center; 
    }
    .pdf-header-wrapper h1 { color: var(--fire-red); margin: 0; font-size: 36px; font-weight: bold; text-transform: uppercase; }
    .company-details { font-size: 12px; color: #0000EE; line-height: 1.2; margin-top: 1px; } 
    
    .pdf-body-content { width: 100%; box-sizing: border-box; margin-top: 0; padding-top: 0; } 
    .pdf-body-content h2 { 
        margin-top: 0; 
        margin-bottom: 6px; 
        font-size: 18px; 
        color: #0000EE; 
        border-bottom: none; 
        padding-bottom: 2px; 
        text-align: center; 
        text-transform: uppercase; 
        font-weight: 800;
    }
    .pdf-body-content p { text-align: justify; font-size: 11px; line-height: 1.4; margin: 0 0 2px 0; color: #333; white-space: pre-wrap; }
    .footer-bar-red { width: 100%; height: 2px; background: var(--fire-red); margin-bottom: 1px; }
    .footer-text { font-size: 9pt; color: #0000EE; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }
    .pdf-body-content .to-address { font-size: 12px; color: #000000; }
    .pdf-body-content .to-address strong { font-size: 12px; color: #000000; }
    .pdf-body-content .quote-meta { font-size: 12px; color: #000000; }
    .pdf-body-content .subject-line { font-size: 12px; font-weight: bold; color: #000000; margin-bottom: 2px; }
    .pdf-body-content .slogan-text { font-size: 12px; color: #0000EE; font-weight: bold; }
    .pdf-body-content .company-signature { font-size: 11px; color: #000000; margin-top: 2px; }
    .pdf-body-content .amount-words { font-size: 11px; color: #000000; margin: 2px 0 2px 0; }
    .pdf-body-content .terms-text { font-size: 11px; color: #000000; margin: 2px 0 2px 0; white-space: pre-wrap; }
    
    .pdf-body-content .quotation-print-table, 
    .pdf-body-content .quotation-print-table th, 
    .pdf-body-content .quotation-print-table td {
        border: 1px solid #000000 !important;
        border-collapse: collapse;
    }
    .pdf-body-content .quotation-print-table th {
        border: 1px solid #000000 !important;
        background: #f2f2f2 !important;
    }
    
    .pdf-body-content .quotation-print-table { margin-bottom: 1px; }
    .pdf-body-content .quotation-print-table th { 
        font-size: 11px; 
        color: #000000; 
        font-weight: bold; 
        text-align: center; 
    }
    .pdf-body-content .quotation-print-table td { 
        font-size: 11px; 
        color: #000000; 
    }
    .pdf-body-content .quotation-print-table td:nth-child(1),
    .pdf-body-content .quotation-print-table td:nth-child(3),
    .pdf-body-content .quotation-print-table td:nth-child(4),
    .pdf-body-content .quotation-print-table td:nth-child(5),
    .pdf-body-content .quotation-print-table td:nth-child(6) {
        text-align: center;
    }
    .pdf-body-content .quotation-print-table td:nth-child(2) { text-align: left; }
    .pdf-body-content .quotation-print-table td:nth-child(7) { text-align: right; }
    
    .pdf-body-content .quotation-print-table tfoot {
        display: none;
    }
    .signature-wrapper {
        text-align: right;
        margin-top: 30px;
    }
    .signature-wrapper img {
        max-height: 40px;
        display: inline-block;
    }
    .signature-bar {
        width: 200px;
        height: 1px;
        background: #000;
        margin: 2px 0 0 auto;
    }
}

@supports (padding: max(0px)) {
    .interface-bar, .tab-nav, .tab-content {
        padding-left: max(16px, env(safe-area-inset-left));
        padding-right: max(16px, env(safe-area-inset-right));
    }
    
    .interface-bar {
        padding-top: max(18px, env(safe-area-inset-top));
    }
}

@media (max-width: 768px) {
    input, textarea, select {
        font-size: 16px;
    }
}

/* ============================================= */
/* FULLY MOBILE RESPONSIVE ENHANCEMENTS */
/* ============================================= */

@media (max-width: 480px) {
    .tab-link strong {
        font-size: 10px;
        line-height: 1.1;
    }
    
    .tab-link svg {
        width: 22px;
        height: 22px;
        margin-bottom: 4px;
    }
    
    .tab-link {
        padding: 8px 4px;
        min-height: 72px;
    }
    
    .accounts-sub-link {
        padding: 14px 8px;
        min-width: 120px;
    }
    
    .accounts-sub-link span {
        font-size: 13px;
    }
    
    .summary-card {
        min-width: 130px;
        padding: 10px 12px;
    }
    
    .summary-card .card-value {
        font-size: 18px;
    }
    
    .summary-card .card-title {
        font-size: 10px;
    }
    
    .section-divider {
        font-size: 13px;
        margin: 24px 0 16px;
    }
    
    h2 {
        font-size: 18px;
    }
    
    .doc-card h3 {
        font-size: 15px;
    }
    
    table th, table td {
        padding: 12px 8px;
        font-size: 13px;
    }
    
    .table-container {
        margin-top: 12px;
    }
    
    .modal-content {
        padding: 20px 15px;
    }
    
    .btn-save, .btn-back {
        padding: 16px;
        font-size: 14px;
    }
}

.loading {
    opacity: 0.7;
    pointer-events: none;
}

.no-data {
    text-align: center;
    padding: 40px 20px;
    color: #666;
    font-size: 14px;
}

.suggestions-dropdown {
    position: absolute;
    background: white;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    display: none;
}

.suggestion-item {
    padding: 12px 15px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    font-size: 14px;
}

.suggestion-item:hover {
    background: #f8f9fa;
}

.suggestion-item:last-child {
    border-bottom: none;
}

.item-modal-content {
    max-width: 600px;
}

.item-form-group {
    margin-bottom: 15px;
}

.item-form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: var(--charcoal);
    font-size: 13px;
}

.item-input {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
}

.item-input:focus {
    outline: none;
    border-color: var(--fire-red);
}

.items-table-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 15px 0;
}

.total-display {
    font-size: 16px;
    font-weight: bold;
    color: var(--fire-red);
}

.toast-notification {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--fire-red);
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: bold;
    z-index: 9999;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    animation: slideUp 0.3s ease;
    max-width: 90%;
    text-align: center;
}

@keyframes slideUp {
    from { transform: translate(-50%, 100%); opacity: 0; }
    to { transform: translate(-50%, 0); opacity: 1; }
}

@keyframes slideDown {
    from { transform: translate(-50%, 0); opacity: 1; }
    to { transform: translate(-50%, 100%); opacity: 0; }
}

#capture-container {
    position: absolute;
    left: -9999px;
    top: -9999px;
    width: 210mm;
    background: white;
}

/* Search bar styling - instant quick search */
.search-box {
    margin-bottom: 20px;
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}
.search-box input {
    flex: 1;
    padding: 14px;
    border: 2px solid #edf0f2;
    border-radius: 40px;
    font-size: 15px;
    transition: all 0.05s ease;
}
.search-box input:focus {
    border-color: var(--fire-red);
}

/* ===== ACCOUNTS SUB FOLDER STYLES - FULLY MOBILE RESPONSIVE, HORIZONTAL SUMMARY ===== */
.accounts-sub-nav {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin: 25px 0 20px;
    justify-content: space-between;
    width: 100%;
}
.accounts-sub-link {
    flex: 1 1 calc(25% - 12px);
    min-width: 140px;
    background: #ffffff;
    border-radius: 12px;
    padding: 18px 10px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    box-shadow: 0 6px 12px rgba(0,0,0,0.04);
    border: 1px solid rgba(0,0,0,0.05);
    transition: all 0.2s ease;
    cursor: pointer;
    aspect-ratio: 1 / 0.9;
}
.accounts-sub-link:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 20px rgba(0,0,0,0.08);
}
.accounts-sub-link svg {
    width: 36px;
    height: 36px;
    margin-bottom: 8px;
}
.accounts-sub-link span {
    font-size: clamp(14px, 4.5vw, 17px); /* ENHANCED FOR MOBILE */
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    line-height: 1.3;
}
.accounts-sub-content {
    display: none;  /* HIDE ALL BY DEFAULT ‚Äî only active shows in popup */
    margin-top: 20px;
    padding: 20px;
    background: #fcfcfc;
    border-radius: 16px;
    border: 1px solid var(--border-color);
}
.accounts-sub-content.active {
    display: block;  /* ONLY ACTIVE ONE VISIBLE (for popup) */
}

/* ===== PROFESSIONAL SUMMARY CARDS - NOW HORIZONTAL FLEX WRAP WITH SHRINK ===== */
.summary-cards {
    display: flex;
    flex-wrap: nowrap;
    gap: 12px;
    margin-bottom: 25px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 5px;
    scrollbar-width: thin;
    justify-content: flex-start;
}
.summary-card {
    background: white;
    border-radius: 12px;
    padding: 12px 16px;
    flex: 0 0 auto;
    width: auto;
    min-width: 150px;
    max-width: 180px;
    box-shadow: 0 8px 15px rgba(0,0,0,0.04);
    border-left: 8px solid;
    transition: transform 0.15s ease;
    display: flex;
    flex-direction: column;
}
.summary-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 22px rgba(0,0,0,0.06);
}
.summary-card .card-title {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.4px;
    font-weight: 700;
    color: #666;
    margin-bottom: 4px;
    white-space: nowrap;
}
.summary-card .card-value {
    font-size: 20px;
    font-weight: 800;
    color: var(--charcoal);
    line-height: 1.1;
    margin-bottom: 2px;
    white-space: nowrap;
}
.summary-card .card-sub {
    font-size: 10px;
    color: #888;
    white-space: nowrap;
}
.wo-card { border-left-color: var(--accounts-workorder); }
.income-card { border-left-color: var(--accounts-income); }
.expense-card { border-left-color: var(--accounts-expense); }
.trans-card { border-left-color: var(--accounts-transaction); }

/* highlight row for transaction view */
.credit-text { color: var(--success-green); font-weight: 600; }
.debit-text { color: var(--accounts-expense); font-weight: 600; }

/* ===== MODAL POPUP FOR ACCOUNTS SUB TAB ===== */
.accounts-sub-popup-modal {
    display: none;
    position: fixed;
    z-index: 3000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(20,20,20,0.85);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    overflow-y: auto;
    padding: 15px;
}
.accounts-sub-popup-content {
    background: white;
    margin: 30px auto;
    padding: 30px 25px;
    width: 95%;
    max-width: 1000px;
    border-radius: 24px;
    position: relative;
    box-shadow: 0 25px 50px -8px rgba(0,0,0,0.3);
    border-top: 8px solid;
    animation: popFade 0.25s ease;
}
@keyframes popFade {
    from { opacity: 0.5; transform: scale(0.97); }
    to { opacity: 1; transform: scale(1); }
}
.accounts-sub-popup-close {
    position: absolute;
    right: 25px;
    top: 20px;
    font-size: 35px;
    font-weight: 300;
    cursor: pointer;
    color: #aaa;
    line-height: 1;
    transition: color 0.2s;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
}
.accounts-sub-popup-close:hover {
    color: var(--fire-red);
    background: #f5f5f5;
}
.accounts-popup-title {
    font-size: 26px;
    font-weight: 800;
    margin: 0 0 15px 0;
    padding-bottom: 15px;
    border-bottom: 3px solid;
    letter-spacing: 1px;
    text-transform: uppercase;
}
.accounts-popup-summary {
    margin-bottom: 30px;
    background: #fafbfc;
    padding: 20px;
    border-radius: 18px;
}
.accounts-popup-body {
    width: 100%;
    overflow-x: auto;
}
/* Ensure popup tables are scrollable on mobile */
@media (max-width: 640px) {
    .accounts-sub-popup-content {
        padding: 20px 15px;
        width: 98%;
    }
    .summary-cards {
        gap: 10px;
    }
    .summary-card {
        min-width: 140px;
        padding: 10px 14px;
    }
    .summary-card .card-value {
        font-size: 18px;
    }
}
</style>
</head>

<body>

<div class="container" id="main-ui">
    <div class="interface-bar">
        <h1>Arvin Controls</h1>
    </div>

    <nav class="tab-nav" id="folder-grid">
        <!-- 1. CLIENTS -->
        <button class="tab-link" onclick="openTab('clients-tab')" style="border-bottom-color: #3498db;">
            <svg viewBox="0 0 24 24" fill="none" stroke="#3498db" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
            <strong style="color:#3498db;">Clients</strong>
        </button>
        <!-- 2. SUPPLIER -->
        <button class="tab-link" onclick="openTab('supplier-tab')" style="border-bottom-color: #27ae60;">
            <svg viewBox="0 0 24 24" fill="none" stroke="#27ae60" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
            <strong style="color:#27ae60;">Supplier</strong>
        </button>
        <!-- 3. PRODUCTS -->
        <button class="tab-link" onclick="openTab('products-tab')" style="border-bottom-color: #9b59b6;">
            <svg viewBox="0 0 24 24" fill="none" stroke="#9b59b6" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
            <strong style="color:#9b59b6;">Products</strong>
        </button>
        <!-- 4. INVENTORY -->
        <button class="tab-link" onclick="openTab('inventory-tab')" style="border-bottom-color: #f1c40f;">
            <svg viewBox="0 0 24 24" fill="none" stroke="#f1c40f" stroke-width="2"><path d="M21 7.5V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v1.5"></path><path d="M21 12H3"></path><path d="M3 18v1.5a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V18"></path><rect x="9" y="8" width="6" height="8"></rect></svg>
            <strong style="color:#f1c40f;">Inventory</strong>
        </button>
        <!-- 5. QUOTATION (MOVED TO 5TH POSITION) -->
        <button class="tab-link" onclick="openTab('quotation-tab')" style="border-bottom-color: #e67e22;">
            <svg viewBox="0 0 24 24" fill="none" stroke="#e67e22" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
            <strong style="color:#e67e22;">Quotation</strong>
        </button>
        <!-- 6. INVOICE -->
        <button class="tab-link" onclick="openTab('invoice-tab')" style="border-bottom-color: #e74c3c;">
            <svg viewBox="0 0 24 24" fill="none" stroke="#e74c3c" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
            <strong style="color:#e74c3c;">Invoice</strong>
        </button>
        <!-- 7. DELIVERY -->
        <button class="tab-link" onclick="openTab('delivery-tab')" style="border-bottom-color: #1abc9c;">
            <svg viewBox="0 0 24 24" fill="none" stroke="#1abc9c" stroke-width="2"><rect x="1" y="3" width="15" height="13"></rect><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"></polygon><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>
            <strong style="color:#1abc9c;">Delivery</strong>
        </button>
        <!-- 8. PURCHASE -->
        <button class="tab-link" onclick="openTab('purchase-tab')" style="border-bottom-color: #34495e;">
            <svg viewBox="0 0 24 24" fill="none" stroke="#34495e" stroke-width="2"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>
            <strong style="color:#34495e;">Purchase</strong>
        </button>
        <!-- 9. RECEIPT -->
        <button class="tab-link" onclick="openTab('receipt-tab')" style="border-bottom-color: #d35400;">
            <svg viewBox="0 0 24 24" fill="none" stroke="#d35400" stroke-width="2"><path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"></path><path d="M4 6v12c0 1.1.9 2 2 2h14v-4"></path><path d="M18 12a2 2 0 0 0-2 2c0 1.1.9 2 2 2h4v-4h-4z"></path></svg>
            <strong style="color:#d35400;">Receipt</strong>
        </button>
        <!-- 10. LETTER -->
        <button class="tab-link" onclick="openTab('letter-tab')" style="border-bottom-color: #2980b9;">
            <svg viewBox="0 0 24 24" fill="none" stroke="#2980b9" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
            <strong style="color:#2980b9;">Letter</strong>
        </button>
        <!-- 11. ACCOUNTS -->
        <button class="tab-link" onclick="openTab('accounts-tab')" style="border-bottom-color: #2c3e50;">
            <svg viewBox="0 0 24 24" fill="none" stroke="#2c3e50" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
            <strong style="color:#2c3e50;">Accounts</strong>
        </button>
        <!-- 12. SETTINGS -->
        <button class="tab-link" onclick="openTab('settings-tab')" style="border-bottom-color: #8e44ad;">
            <svg viewBox="0 0 24 24" fill="none" stroke="#8e44ad" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            <strong style="color:#8e44ad;">Settings</strong>
        </button>
    </nav>

    <div class="content-box">
        <!-- ========== QUOTATION TAB - NOW 5TH POSITION ========== -->
        <div id="quotation-tab" class="tab-content">
            <button class="btn-back" onclick="closeTabs()">Back to Dashboard</button>
            <button class="add-new-btn" onclick="showQuotationModal()">+ New Quotation</button>
            <div id="quotationsList"></div>
            <div class="placeholder-msg" id="noQuotationsMsg">
                <h3>No Quotations Created</h3>
                <p>Create your first quotation to get started.</p>
            </div>
        </div>

        <!-- CLIENTS TAB with instant search -->
        <div id="clients-tab" class="tab-content">
            <button class="btn-back" onclick="closeTabs()">‚Üê Back</button>
            <button class="add-new-btn" onclick="showContactModal('client')">+ Add Client</button>
            <div class="search-box">
                <input type="text" id="clientSearch" placeholder="üîç Search by name, contact, email..." oninput="debounce('client', renderContacts)()">
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>SL</th>
                            <th>Client Name</th>
                            <th>Contact Person</th>
                            <th>Mobile</th>
                            <th>Email</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="clientTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- SUPPLIER TAB with instant search -->
        <div id="supplier-tab" class="tab-content">
            <button class="btn-back" onclick="closeTabs()">‚Üê Back</button>
            <button class="add-new-btn" onclick="showContactModal('supplier')">+ Add Supplier</button>
            <div class="search-box">
                <input type="text" id="supplierSearch" placeholder="üîç Search by name, contact, email..." oninput="debounce('supplier', renderContacts)()">
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>SL</th>
                            <th>Supplier Name</th>
                            <th>Contact Person</th>
                            <th>Mobile</th>
                            <th>Email</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="supplierTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- PRODUCTS TAB with instant search + stock qty -->
        <div id="products-tab" class="tab-content">
            <button class="btn-back" onclick="closeTabs()">‚Üê Back</button>
            <button class="add-new-btn" onclick="showProductModal()">+ Add Product</button>
            <div class="search-box">
                <input type="text" id="productSearch" placeholder="üîç Search product name, description..." oninput="debounceProduct()">
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>SL</th>
                            <th>Item</th>
                            <th>Description</th>
                            <th>Unit</th>
                            <th>Unit Price</th>
                            <th>Stock Qty</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- INVENTORY TAB with instant search -->
        <div id="inventory-tab" class="tab-content">
            <button class="btn-back" onclick="closeTabs()">‚Üê Back</button>
            <div class="search-box">
                <input type="text" id="inventorySearch" placeholder="üîç Search product name..." oninput="debounceInventory()">
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>SL</th>
                            <th>Item</th>
                            <th>Description</th>
                            <th>Stock Qty</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTableBody"></tbody>
                </table>
            </div>
            <div class="placeholder-msg" id="noInventoryMsg" style="display:none;"><h3>No Products in Inventory</h3><p>Add products with stock quantity.</p></div>
        </div>
        
        <!-- INVOICE TAB -->
        <div id="invoice-tab" class="tab-content">
            <button class="btn-back" onclick="closeTabs()">‚Üê Back</button>
            <button class="add-new-btn" onclick="showInvoiceModal()">+ New Invoice</button>
            <div id="invoicesList"></div>
            <div class="placeholder-msg" id="noInvoicesMsg" style="display:none;"><h3>No Invoices</h3><p>Create your first invoice.</p></div>
        </div>
        
        <!-- DELIVERY TAB -->
        <div id="delivery-tab" class="tab-content">
            <button class="btn-back" onclick="closeTabs()">‚Üê Back</button>
            <button class="add-new-btn" onclick="showDeliveryChallanModal()">+ New Delivery Challan</button>
            <div id="deliveryList"></div>
            <div class="placeholder-msg" id="noDeliveryMsg" style="display:none;"><h3>No Delivery Challans</h3><p>Create first challan.</p></div>
        </div>
        
        <!-- PURCHASE TAB -->
        <div id="purchase-tab" class="tab-content">
            <button class="btn-back" onclick="closeTabs()">‚Üê Back</button>
            <button class="add-new-btn" onclick="showPurchaseOrderModal()">+ New Purchase Order</button>
            <div id="purchaseOrdersList"></div>
            <div class="placeholder-msg" id="noPurchaseMsg" style="display:none;"><h3>No Purchase Orders</h3><p>Create PO using supplier data.</p></div>
        </div>
        
        <!-- RECEIPT TAB -->
        <div id="receipt-tab" class="tab-content">
            <button class="btn-back" onclick="closeTabs()">‚Üê Back</button>
            <button class="add-new-btn" onclick="showMoneyReceiptModal()">+ New Money Receipt</button>
            <div id="receiptList"></div>
            <div class="placeholder-msg" id="noReceiptMsg" style="display:none;"><h3>No Money Receipts</h3><p>Create money receipt.</p></div>
        </div>
        
        <!-- LETTER TAB -->
        <div id="letter-tab" class="tab-content">
            <button class="btn-back" onclick="closeTabs()">‚Üê Back</button>
            <button class="add-new-btn" onclick="showLetterModal()">+ New Letter</button>
            <div id="lettersList"></div>
            <div class="placeholder-msg" id="noLettersMsg" style="display:none;"><h3>No Letters</h3><p>Draft company letters.</p></div>
        </div>
        
        <!-- ========== ACCOUNTS TAB with colorful sub folders - FULLY MOBILE RESPONSIVE, HORIZONTAL SUMMARY ========== -->
        <div id="accounts-tab" class="tab-content">
            <button class="btn-back" onclick="closeTabs()">‚Üê Back</button>
            
            <!-- Colorful Sub-Folder Navigation - now triggers popup window -->
            <div class="accounts-sub-nav">
                <div class="accounts-sub-link" onclick="openAccountsSubPopup('accounts-workorder')" style="border-top: 6px solid var(--accounts-workorder);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--accounts-workorder)" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>
                    <span style="color: var(--accounts-workorder);">Work Orders</span>
                </div>
                <div class="accounts-sub-link" onclick="openAccountsSubPopup('accounts-income')" style="border-top: 6px solid var(--accounts-income);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--accounts-income)" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                    <span style="color: var(--accounts-income);">Income</span>
                </div>
                <div class="accounts-sub-link" onclick="openAccountsSubPopup('accounts-expense')" style="border-top: 6px solid var(--accounts-expense);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--accounts-expense)" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                    <span style="color: var(--accounts-expense);">Expense</span>
                </div>
                <div class="accounts-sub-link" onclick="openAccountsSubPopup('accounts-transaction')" style="border-top: 6px solid var(--accounts-transaction);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--accounts-transaction)" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>
                    <span style="color: var(--accounts-transaction);">Transactions</span>
                </div>
            </div>
            
            <!-- Sub Tab Content Panels - hidden, used as source for popup, summary cards already updated with horizontal flex -->
            <!-- WORK ORDER SUB TAB - header title removed, buttons centered via inline style in JS -->
            <div id="accounts-workorder" class="accounts-sub-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom:15px;">
                    <!-- Removed header text per request -->
                    <div style="width:100%; text-align:right;">
                        <button class="add-new-btn" style="max-width: 180px; background: var(--accounts-workorder);" onclick="showWorkOrderModal()">+ New Work Order</button>
                    </div>
                </div>
                <!-- SUMMARY CARDS - HORIZONTAL SCROLL (MOBILE RESPONSIVE) -->
                <div class="summary-cards" id="wo-summary-container">
                    <div class="summary-card wo-card">
                        <span class="card-title">Total Value</span>
                        <span class="card-value" id="wo-total-value">0.00</span>
                        <span class="card-sub">All work orders</span>
                    </div>
                    <div class="summary-card wo-card">
                        <span class="card-title">Total Cost</span>
                        <span class="card-value" id="wo-total-cost">0.00</span>
                        <span class="card-sub">Direct expenses</span>
                    </div>
                    <div class="summary-card wo-card">
                        <span class="card-title">Total Profit</span>
                        <span class="card-value" id="wo-total-profit">0.00</span>
                        <span class="card-sub">Value - Cost</span>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>SL</th><th>Client</th><th>Date</th><th>WO Type</th><th>WO Value</th><th>WO Cost</th><th>Profit</th><th style="text-align:center;">Action</th></tr></thead>
                        <tbody id="workorder-table-body"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- INCOME SUB TAB - header title removed -->
            <div id="accounts-income" class="accounts-sub-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom:15px;">
                    <!-- Removed header text -->
                    <div style="width:100%; text-align:right;">
                        <button class="add-new-btn" style="max-width: 180px; background: var(--accounts-income);" onclick="showIncomeModal()">+ Record Income</button>
                    </div>
                </div>
                <div class="summary-cards" id="income-summary-container">
                    <div class="summary-card income-card">
                        <span class="card-title">Total Income</span>
                        <span class="card-value" id="income-total">0.00</span>
                        <span class="card-sub">All time</span>
                    </div>
                    <div class="summary-card income-card">
                        <span class="card-title">This Month</span>
                        <span class="card-value" id="income-month">0.00</span>
                        <span class="card-sub">Current month</span>
                    </div>
                    <div class="summary-card income-card">
                        <span class="card-title">This Year</span>
                        <span class="card-value" id="income-year">0.00</span>
                        <span class="card-sub">Year to date</span>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>SL</th><th>Date</th><th>Purpose</th><th>Amount</th><th style="text-align:center;">Action</th></tr></thead>
                        <tbody id="income-table-body"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- EXPENSE SUB TAB - header title removed -->
            <div id="accounts-expense" class="accounts-sub-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom:15px;">
                    <!-- Removed header text -->
                    <div style="width:100%; text-align:right;">
                        <button class="add-new-btn" style="max-width: 180px; background: var(--accounts-expense);" onclick="showExpenseModal()">+ Record Expense</button>
                    </div>
                </div>
                <div class="summary-cards" id="expense-summary-container">
                    <div class="summary-card expense-card">
                        <span class="card-title">Total Expense</span>
                        <span class="card-value" id="expense-total">0.00</span>
                        <span class="card-sub">All time</span>
                    </div>
                    <div class="summary-card expense-card">
                        <span class="card-title">This Month</span>
                        <span class="card-value" id="expense-month">0.00</span>
                        <span class="card-sub">Current month</span>
                    </div>
                    <div class="summary-card expense-card">
                        <span class="card-title">This Year</span>
                        <span class="card-value" id="expense-year">0.00</span>
                        <span class="card-sub">Year to date</span>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>SL</th><th>Date</th><th>Purpose</th><th>Amount</th><th style="text-align:center;">Action</th></tr></thead>
                        <tbody id="expense-table-body"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- TRANSACTIONS SUB TAB - header title removed, no add button -->
            <div id="accounts-transaction" class="accounts-sub-content" style="display: none;">
                <!-- Removed header and button div entirely -->
                <div class="summary-cards" id="transaction-summary-container">
                    <div class="summary-card trans-card">
                        <span class="card-title">Total Income</span>
                        <span class="card-value" id="trans-total-income">0.00</span>
                        <span class="card-sub">All time</span>
                    </div>
                    <div class="summary-card trans-card">
                        <span class="card-title">Total Expense</span>
                        <span class="card-value" id="trans-total-expense">0.00</span>
                        <span class="card-sub">All time</span>
                    </div>
                    <div class="summary-card trans-card">
                        <span class="card-title">Net Balance</span>
                        <span class="card-value" id="trans-net-balance">0.00</span>
                        <span class="card-sub">Income - Expense</span>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Date</th><th>Type</th><th>Purpose / Client</th><th>Credit</th><th>Debit</th><th>Balance</th></tr></thead>
                        <tbody id="transaction-table-body"></tbody>
                    </table>
                </div>
                <div style="margin-top:10px; text-align:right; font-weight:bold;">Running Balance: <span id="transaction-balance">0.00</span></div>
            </div>
        </div>

        <div id="settings-tab" class="tab-content">
            <button class="btn-back" onclick="closeTabs()">Back to Dashboard</button>
            
            <div class="section-divider">Company Information</div>
            <div class="grid-2">
                <div class="form-group">
                    <label>Company Name</label>
                    <input type="text" id="setCompanyName" placeholder="Arvin Controls Ltd.">
                </div>
                <div class="form-group">
                    <label>Slogan / Tagline</label>
                    <input type="text" id="setSlogan" placeholder="Excellence in Fire Protection">
                </div>
            </div>
            <div class="form-group">
                <label>Company Address</label>
                <textarea id="setAddress" style="height: 60px;"></textarea>
            </div>
            <div class="grid-2">
                <div class="form-group">
                    <label>Official Email</label>
                    <input type="email" id="setEmail" placeholder="info@Arvin Controls.com">
                </div>
                <div class="form-group">
                    <label>Mobile Number</label>
                    <input type="tel" id="setMobile" placeholder="+880...">
                </div>
                <div class="form-group">
                    <label>Website URL</label>
                    <input type="text" id="setWebsite" placeholder="www.Arvin Controls.com">
                </div>
            </div>

            <div class="section-divider">Currency & Localization</div>
            <div class="grid-2">
                <div class="form-group">
                    <label>Select Currency</label>
                    <select id="setCurrency">
                        <option value="‚Çπ">‚Çπ (INR)</option>
                        <option value="‡ß≥">‡ß≥ (BDT)</option>
                        <option value="$">$ (USD)</option>
                    </select>
                </div>
            </div>

            <div class="section-divider">Assets & Branding (Uploads)</div>
            <div class="grid-2">
                <div class="form-group">
                    <label>Company Logo</label>
                    <input type="file" id="uploadLogo" accept="image/*" onchange="previewFile('uploadLogo', 'logoPreview')">
                    <img id="logoPreview" class="preview-img" src="" alt="Logo Preview" style="display:none;">
                </div>
                <div class="form-group">
                    <label>Company Seal</label>
                    <input type="file" id="uploadSeal" accept="image/*" onchange="previewFile('uploadSeal', 'sealPreview')">
                    <img id="sealPreview" class="preview-img" src="" alt="Seal Preview" style="display:none;">
                </div>
            </div>

            <div class="section-divider">Legal & Authority</div>
            <div class="grid-2">
                <div class="form-group">
                    <label>Authorized Signatory Name</label>
                    <input type="text" id="setSignatoryName">
                </div>
                <div class="form-group">
                    <label>Signatory Designation</label>
                    <input type="text" id="setSignatoryDesignation">
                </div>
                <div class="form-group">
                    <label>Upload Signatory Sign</label>
                    <input type="file" id="uploadSign" accept="image/*" onchange="previewFile('uploadSign', 'signPreview')">
                    <img id="signPreview" class="preview-img" src="" alt="Sign Preview" style="display:none;">
                </div>
            </div>

            <div class="section-divider">Terms & Conditions (Footer Text)</div>
            <div class="grid-2">
                <div class="form-group">
                    <label>Quotation Terms</label>
                    <textarea id="termsQuotation" placeholder="Enter terms for Quotations..."></textarea>
                </div>
                <div class="form-group">
                    <label>Invoice Terms</label>
                    <textarea id="termsInvoice" placeholder="Enter terms for Invoices..."></textarea>
                </div>
                <div class="form-group">
                    <label>Challan Terms</label>
                    <textarea id="termsChallan" placeholder="Enter terms for Delivery Challans..."></textarea>
                </div>
                <div class="form-group">
                    <label>Purchase Order (PO) Terms</label>
                    <textarea id="termsPO" placeholder="Enter terms for POs..."></textarea>
                </div>
            </div>

            <button class="btn-save" onclick="saveSettings()">UPDATE ALL SYSTEM SETTINGS</button>
        </div>
    </div>
</div>

<!-- MODALS (identical to original, unchanged) -->
<!-- QUOTATION MODAL -->
<div id="quotationModal" class="modal">
    <div class="modal-content item-modal-content">
        <span class="close-modal" onclick="closeQuotationModal()">√ó</span>
        <h2 id="quotationModalTitle" style="margin-top:0; color:var(--fire-red);">New Quotation</h2>
        <input type="hidden" id="editQuotationIndex">
        <div class="form-group">
            <label>Client <small>(Start typing)</small></label>
            <input type="text" id="quotationClient" oninput="showClientSuggestions('quotation')" placeholder="Type client name...">
            <div id="clientSuggestions" class="suggestions-dropdown"></div>
        </div>
        <div class="form-group"><label>Address</label><textarea id="quotationAddress" readonly></textarea></div>
        <div class="grid-2">
            <div class="form-group"><label>Quotation No.</label><input type="text" id="quotationId" readonly></div>
            <div class="form-group"><label>Ref / Order ID</label><input type="text" id="quotationRef" placeholder="Ref/Order ID"></div>
        </div>
        <div class="grid-2">
            <div class="form-group"><label>Date</label><input type="date" id="quotationDate"></div>
            <div class="form-group"><label>Subject</label><input type="text" id="quotationSubject" placeholder="Quotation subject"></div>
        </div>
        <div class="grid-2">
            <div class="form-group"><label>VAT %</label><input type="number" id="quotationVATPercent" value="0" step="0.1" oninput="calculateQuotationGrandTotal()"></div>
            <div class="form-group"><label>AIT %</label><input type="number" id="quotationAITPercent" value="0" step="0.1" oninput="calculateQuotationGrandTotal()"></div>
        </div>
        <div class="section-divider">Items</div>
        <div class="items-table-actions">
            <button class="action-btn edit-btn" onclick="addQuotationItem()">+ Add Item</button>
            <div class="total-display">Total: <span id="quotationGrandTotalDisplay">0.00</span></div>
        </div>
        <div class="table-container">
            <table><thead><tr><th>SL</th><th>Item</th><th>Description</th><th>Qty</th><th>Unit</th><th>Price</th><th>Total</th><th>Action</th></tr></thead><tbody id="quotationItemsTable"></tbody></table>
        </div>
        <div class="form-group"><label>Notes / Terms</label><textarea id="quotationNotes" placeholder="Additional notes or terms..."></textarea></div>
        <button class="btn-save" onclick="saveQuotation()">SAVE QUOTATION</button>
    </div>
</div>

<!-- INVOICE MODAL -->
<div id="invoiceModal" class="modal">
    <div class="modal-content item-modal-content">
        <span class="close-modal" onclick="closeInvoiceModal()">√ó</span>
        <h2 id="invoiceModalTitle" style="margin-top:0; color:var(--fire-red);">New Invoice</h2>
        <input type="hidden" id="editInvoiceIndex">
        <div class="form-group">
            <label>Client <small>(Start typing)</small></label>
            <input type="text" id="invoiceClient" oninput="showClientSuggestions('invoice')" placeholder="Type client name...">
            <div id="invoiceClientSuggestions" class="suggestions-dropdown"></div>
        </div>
        <div class="form-group"><label>Address</label><textarea id="invoiceAddress" readonly></textarea></div>
        <div class="grid-2">
            <div class="form-group"><label>Invoice No.</label><input type="text" id="invoiceNo" readonly></div>
            <div class="form-group"><label>Order ID</label><input type="text" id="invoiceOrderId" placeholder="Ref order/PO"></div>
        </div>
        <div class="grid-2">
            <div class="form-group"><label>Date</label><input type="date" id="invoiceDate"></div>
            <div class="form-group"><label>Subject</label><input type="text" id="invoiceSubject" placeholder="Invoice subject"></div>
        </div>
        <div class="section-divider">Items</div>
        <div class="items-table-actions">
            <button class="action-btn edit-btn" onclick="addInvoiceItem()">+ Add Item</button>
            <div class="total-display">Total: <span id="invoiceGrandTotal">0.00</span></div>
        </div>
        <div class="table-container">
            <table><thead><tr><th>SL</th><th>Item</th><th>Description</th><th>Qty</th><th>Unit</th><th>Price</th><th>Total</th><th>Action</th></tr></thead><tbody id="invoiceItemsTable"></tbody></table>
        </div>
        <div class="grid-2">
            <div class="form-group"><label>Paid Amount</label><input type="number" id="invoicePaid" value="0" step="0.01" min="0" oninput="updateInvoiceDue()"></div>
            <div class="form-group"><label>Due Amount</label><input type="number" id="invoiceDue" readonly style="background:#f5f5f5; font-weight:bold; color:var(--fire-red);"></div>
        </div>
        <div class="form-group"><label>Notes</label><textarea id="invoiceNotes"></textarea></div>
        <button class="btn-save" onclick="saveInvoice()">SAVE INVOICE</button>
    </div>
</div>

<!-- DELIVERY CHALLAN MODAL -->
<div id="deliveryModal" class="modal">
    <div class="modal-content item-modal-content">
        <span class="close-modal" onclick="closeDeliveryModal()">√ó</span>
        <h2 style="margin-top:0; color:var(--fire-red);">New Delivery Challan</h2>
        <input type="hidden" id="editDeliveryIndex">
        <div class="form-group"><label>Client</label><input type="text" id="deliveryClient" oninput="showClientSuggestions('delivery')"><div id="deliveryClientSuggestions" class="suggestions-dropdown"></div></div>
        <div class="form-group"><label>Address</label><textarea id="deliveryAddress" readonly></textarea></div>
        <div class="grid-2">
            <div class="form-group"><label>Challan No.</label><input type="text" id="deliveryNo" readonly></div>
            <div class="form-group"><label>Order ID</label><input type="text" id="deliveryOrderId"></div>
        </div>
        <div class="grid-2">
            <div class="form-group"><label>Gate Pass No.</label><input type="text" id="deliveryGatePass"></div>
            <div class="form-group"><label>Date</label><input type="date" id="deliveryDate"></div>
        </div>
        <div class="section-divider">Items</div>
        <div class="items-table-actions">
            <button class="action-btn edit-btn" onclick="addDeliveryItem()">+ Add Item</button>
        </div>
        <div class="table-container">
            <table><thead><tr><th>SL</th><th>Item</th><th>Description</th><th>Qty</th><th>Unit</th><th>Remarks</th><th>Action</th></tr></thead><tbody id="deliveryItemsTable"></tbody></table>
        </div>
        <button class="btn-save" onclick="saveDeliveryChallan()">SAVE CHALLAN</button>
    </div>
</div>

<!-- PURCHASE ORDER MODAL -->
<div id="purchaseModal" class="modal">
    <div class="modal-content item-modal-content">
        <span class="close-modal" onclick="closePurchaseModal()">√ó</span>
        <h2 style="margin-top:0; color:var(--fire-red);">New Purchase Order</h2>
        <input type="hidden" id="editPOIndex">
        <div class="form-group"><label>Supplier</label><input type="text" id="poSupplier" oninput="showSupplierSuggestions('po')"><div id="poSupplierSuggestions" class="suggestions-dropdown"></div></div>
        <div class="form-group"><label>Address</label><textarea id="poAddress" readonly></textarea></div>
        <div class="grid-2">
            <div class="form-group"><label>PO No.</label><input type="text" id="poId" readonly></div>
            <div class="form-group"><label>Date</label><input type="date" id="poDate"></div>
        </div>
        <div class="form-group"><label>Subject</label><input type="text" id="poSubject"></div>
        <div class="section-divider">Items</div>
        <div class="items-table-actions">
            <button class="action-btn edit-btn" onclick="addPOItem()">+ Add Item</button>
            <div class="total-display">Total: <span id="poGrandTotal">0.00</span></div>
        </div>
        <div class="table-container">
            <table><thead><tr><th>SL</th><th>Item</th><th>Description</th><th>Qty</th><th>Unit</th><th>Unit Price</th><th>Total</th><th>Action</th></tr></thead><tbody id="poItemsTable"></tbody></table>
        </div>
        <div class="form-group"><label>Terms & Notes</label><textarea id="poNotes"></textarea></div>
        <button class="btn-save" onclick="savePurchaseOrder()">SAVE PO</button>
    </div>
</div>

<!-- MONEY RECEIPT MODAL -->
<div id="receiptModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeReceiptModal()">√ó</span>
        <h2 style="margin-top:0; color:var(--fire-red);">Money Receipt</h2>
        <input type="hidden" id="editReceiptIndex">
        <div class="form-group"><label>Received From (Client)</label><input type="text" id="receiptClient" oninput="showClientSuggestions('receipt')"><div id="receiptClientSuggestions" class="suggestions-dropdown"></div></div>
        <div class="form-group"><label>Address</label><textarea id="receiptAddress" readonly></textarea></div>
        <div class="grid-2">
            <div class="form-group"><label>Receipt No.</label><input type="text" id="receiptNo" readonly></div>
            <div class="form-group"><label>Date</label><input type="date" id="receiptDate"></div>
        </div>
        <div class="form-group"><label>Received Amount</label><input type="number" id="receiptAmount" step="0.01" oninput="updateAmountWords()"></div>
        <div class="form-group"><label>Amount in Words</label><textarea id="receiptWords" readonly style="background:#f9f9f9;"></textarea></div>
        <div class="form-group"><label>Payment Mode</label>
            <select id="receiptMode" onchange="toggleChequeFields()">
                <option value="Cash">Cash</option>
                <option value="Cheque">Cheque</option>
                <option value="Mobile Banking">Mobile Banking</option>
                <option value="Pay Order">Pay Order</option>
                <option value="TT">TT</option>
                <option value="Bank Transfer">Bank Transfer</option>
            </select>
        </div>
        <div id="chequeFields" style="display:none;">
            <div class="form-group"><label>Cheque No.</label><input type="text" id="receiptChequeNo"></div>
            <div class="form-group"><label>Bank Name</label><input type="text" id="receiptBankName"></div>
        </div>
        <div class="form-group"><label>Remarks</label><textarea id="receiptRemarks"></textarea></div>
        <button class="btn-save" onclick="saveMoneyReceipt()">SAVE RECEIPT</button>
    </div>
</div>

<!-- LETTER MODAL -->
<div id="letterModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeLetterModal()">√ó</span>
        <h2 style="margin-top:0; color:var(--fire-red);">New Letter</h2>
        <input type="hidden" id="editLetterIndex">
        <div class="form-group"><label>Document Title</label><input type="text" id="letterTitle"></div>
        <div class="grid-2">
            <div class="form-group"><label>Date</label><input type="date" id="letterDate"></div>
            <div class="form-group"><label>Reference</label><input type="text" id="letterRef" placeholder="Ref no."></div>
        </div>
        <div class="form-group"><label>Letter Content (justified)</label><textarea id="letterContent" style="height:200px;" placeholder="Enter text..."></textarea></div>
        <button class="btn-save" onclick="saveLetter()">SAVE LETTER</button>
    </div>
</div>

<!-- COMMON ITEM MODAL -->
<div id="itemModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeItemModal()">√ó</span>
        <h2 id="itemModalTitle" style="margin-top:0; color:var(--fire-red);">Add Item</h2>
        <input type="hidden" id="editItemIndex">
        <input type="hidden" id="itemContext">
        <div class="form-group">
            <label>Item Name <small>(type to select from products)</small></label>
            <input type="text" id="itemName" oninput="showProductSuggestions()" placeholder="Type item name...">
            <div id="productSuggestions" class="suggestions-dropdown"></div>
        </div>
        <div class="form-group"><label>Description</label><textarea id="itemDescription" style="height: 60px;"></textarea></div>
        <div class="grid-2">
            <div class="form-group"><label>Quantity</label><input type="number" id="itemQuantity" value="1" min="1"></div>
            <div class="form-group"><label>Unit</label><input type="text" id="itemUnit" placeholder="PCS, SET"></div>
            <div class="form-group" id="itemPriceGroup"><label>Unit Price</label><input type="number" id="itemUnitPrice" value="0" step="0.01" min="0"></div>
            <div class="form-group" id="itemRemarksGroup" style="display:none;"><label>Remarks</label><input type="text" id="itemRemarks"></div>
        </div>
        <button class="btn-save" onclick="saveItem()">ADD ITEM</button>
    </div>
</div>

<!-- PRODUCT MODAL -->
<div id="productModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeProductModal()">√ó</span>
        <h2 style="margin-top:0; color:var(--fire-red);">Add Product</h2>
        <input type="hidden" id="editProductIndex">
        <div class="form-group"><label>Product Name</label><input type="text" id="productName"></div>
        <div class="form-group"><label>Description</label><textarea id="productDesc" style="height:60px;"></textarea></div>
        <div class="grid-2">
            <div class="form-group"><label>Unit</label><input type="text" id="productUnit" placeholder="PCS, SET"></div>
            <div class="form-group"><label>Unit Price</label><input type="number" id="productPrice" step="0.01"></div>
            <div class="form-group"><label>Stock Qty</label><input type="number" id="productStock" step="1" value="0" min="0"></div>
        </div>
        <button class="btn-save" onclick="saveProduct()">SAVE PRODUCT</button>
    </div>
</div>

<!-- CONTACT MODAL -->
<div id="contactModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeContactModal()">√ó</span>
        <h2 id="modalTitle" style="margin-top:0; color:var(--fire-red);">Add Entity</h2>
        <input type="hidden" id="modalType">
        <input type="hidden" id="editIndex">

        <div class="form-group">
            <label id="nameLabel">Name</label>
            <input type="text" id="modalName">
        </div>
        <div class="form-group">
            <label>Address</label>
            <textarea id="modalAddress" style="height:60px;"></textarea>
        </div>
        <div class="grid-2">
            <div class="form-group">
                <label>Contact Person</label>
                <input type="text" id="modalPerson">
            </div>
            <div class="form-group">
                <label>Designation</label>
                <input type="text" id="modalDesignation">
            </div>
        </div>
        <div class="grid-2">
            <div class="form-group">
                <label>Mobile Number</label>
                <input type="tel" id="modalMobile">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="modalEmail">
            </div>
        </div>
        <button class="btn-save" onclick="saveContact()">SAVE RECORD</button>
    </div>
</div>

<!-- WORK ORDER MODAL -->
<div id="workOrderModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeWorkOrderModal()">√ó</span>
        <h2 style="margin-top:0; color:var(--accounts-workorder);">Work Order Entry</h2>
        <input type="hidden" id="editWorkOrderIndex">
        <div class="form-group"><label>Client</label><input type="text" id="woClient" placeholder="Client Name"></div>
        <div class="form-group"><label>Date</label><input type="date" id="woDate"></div>
        <div class="form-group"><label>WO Type</label><input type="text" id="woType" placeholder="e.g., Installation, AMC"></div>
        <div class="grid-2">
            <div class="form-group"><label>WO Value (‡ß≥)</label><input type="number" id="woValue" step="0.01" min="0"></div>
            <div class="form-group"><label>WO Cost (‡ß≥)</label><input type="number" id="woCost" step="0.01" min="0"></div>
        </div>
        <div class="form-group"><label>Profit (Auto-calc)</label><input type="number" id="woProfit" step="0.01" readonly style="background:#f5f5f5;"></div>
        <button class="btn-save" onclick="saveWorkOrder()">SAVE WORK ORDER</button>
    </div>
</div>

<!-- INCOME MODAL -->
<div id="incomeModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeIncomeModal()">√ó</span>
        <h2 style="margin-top:0; color:var(--accounts-income);">Record Income</h2>
        <input type="hidden" id="editIncomeIndex">
        <div class="form-group"><label>Date</label><input type="date" id="incomeDate"></div>
        <div class="form-group"><label>Purpose</label><input type="text" id="incomePurpose" placeholder="e.g., Project payment, Service fee"></div>
        <div class="form-group"><label>Amount (‡ß≥)</label><input type="number" id="incomeAmount" step="0.01" min="0"></div>
        <button class="btn-save" onclick="saveIncome()">SAVE INCOME</button>
    </div>
</div>

<!-- EXPENSE MODAL -->
<div id="expenseModal" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeExpenseModal()">√ó</span>
        <h2 style="margin-top:0; color:var(--accounts-expense);">Record Expense</h2>
        <input type="hidden" id="editExpenseIndex">
        <div class="form-group"><label>Date</label><input type="date" id="expenseDate"></div>
        <div class="form-group"><label>Purpose</label><input type="text" id="expensePurpose" placeholder="e.g., Office rent, Purchase"></div>
        <div class="form-group"><label>Amount (‡ß≥)</label><input type="number" id="expenseAmount" step="0.01" min="0"></div>
        <button class="btn-save" onclick="saveExpense()">SAVE EXPENSE</button>
    </div>
</div>

<!-- ACCOUNTS SUB POPUP MODAL -->
<div id="accountsSubPopupModal" class="accounts-sub-popup-modal">
    <div class="accounts-sub-popup-content" id="accountsPopupContent">
        <span class="accounts-sub-popup-close" onclick="closeAccountsSubPopup()">√ó</span>
        <div id="accountsPopupInner"></div>
    </div>
</div>

<!-- PRINT AREA -->
<div id="print-area">
    <div class="header-content">
        <div class="pdf-header-wrapper">
            <h1 id="print-comp-name">Arvin Controls</h1>
            <div id="print-comp-address" class="company-details"></div>
            <div id="print-comp-contact" class="company-details"></div>
        </div>
    </div>
    <div class="footer-content">
        <div class="footer-bar-red"></div>
        <div id="print-footer-slogan" class="footer-text"></div>
    </div>
    <table class="print-table">
        <thead><tr><td><div class="header-space">¬†</div></td></tr></thead>
        <tbody>
            <tr><td>
                <div class="pdf-body-content">
                    <h2 id="pdf-title-val">DOCUMENT</h2>
                    <div id="pdf-content-val"></div>
                </div>
            </td></tr>
        </tbody>
        <tfoot><tr><td><div class="footer-space">¬†</div></td></tr></tfoot>
    </table>
</div>

<div id="capture-container"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
// ===================== CORE LOGIC =====================
// (Entire script section remains IDENTICAL to maintain all functionality)
document.addEventListener('touchstart', function(event) {
    if (event.touches.length > 1) event.preventDefault();
}, { passive: false });

let lastTouchEnd = 0;
document.addEventListener('touchend', function(event) {
    const now = (new Date()).getTime();
    if (now - lastTouchEnd <= 300) event.preventDefault();
    lastTouchEnd = now;
}, false);

// GLOBAL DEBOUNCE
let debounceTimer;
function debounce(type, fn) {
    return function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => fn(type), 20);
    };
}
function debounceProduct() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => renderProducts(), 20);
}
function debounceInventory() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => renderInventory(), 20);
}

// ========== ACCOUNTS SUB FOLDERS DATA ==========
let workOrders = JSON.parse(localStorage.getItem('ArvinWorkOrders') || '[]');
let incomeRecords = JSON.parse(localStorage.getItem('ArvinIncomeRecords') || '[]');
let expenseRecords = JSON.parse(localStorage.getItem('ArvinExpenseRecords') || '[]');

function saveWorkOrdersToStorage() { localStorage.setItem('ArvinWorkOrders', JSON.stringify(workOrders)); }
function saveIncomeToStorage() { localStorage.setItem('ArvinIncomeRecords', JSON.stringify(incomeRecords)); }
function saveExpenseToStorage() { localStorage.setItem('ArvinExpenseRecords', JSON.stringify(expenseRecords)); }

// ===== SUMMARY CARD UPDATE FUNCTIONS =====
function updateWorkOrderSummary() {
    let totalValue = 0, totalCost = 0, totalProfit = 0;
    workOrders.forEach(wo => {
        totalValue += parseFloat(wo.value) || 0;
        totalCost += parseFloat(wo.cost) || 0;
        totalProfit += (parseFloat(wo.value)||0) - (parseFloat(wo.cost)||0);
    });
    document.getElementById('wo-total-value') && (document.getElementById('wo-total-value').innerText = totalValue.toFixed(2));
    document.getElementById('wo-total-cost') && (document.getElementById('wo-total-cost').innerText = totalCost.toFixed(2));
    document.getElementById('wo-total-profit') && (document.getElementById('wo-total-profit').innerText = totalProfit.toFixed(2));
}
function updateIncomeSummary() {
    let total = 0, thisMonth = 0, thisYear = 0;
    let now = new Date(), curMonth = now.getMonth(), curYear = now.getFullYear();
    incomeRecords.forEach(inc => {
        let amt = parseFloat(inc.amount) || 0;
        total += amt;
        let d = new Date(inc.date + 'T12:00:00');
        if (!isNaN(d.getTime())) {
            if (d.getMonth() === curMonth && d.getFullYear() === curYear) thisMonth += amt;
            if (d.getFullYear() === curYear) thisYear += amt;
        }
    });
    document.getElementById('income-total') && (document.getElementById('income-total').innerText = total.toFixed(2));
    document.getElementById('income-month') && (document.getElementById('income-month').innerText = thisMonth.toFixed(2));
    document.getElementById('income-year') && (document.getElementById('income-year').innerText = thisYear.toFixed(2));
}
function updateExpenseSummary() {
    let total = 0, thisMonth = 0, thisYear = 0;
    let now = new Date(), curMonth = now.getMonth(), curYear = now.getFullYear();
    expenseRecords.forEach(exp => {
        let amt = parseFloat(exp.amount) || 0;
        total += amt;
        let d = new Date(exp.date + 'T12:00:00');
        if (!isNaN(d.getTime())) {
            if (d.getMonth() === curMonth && d.getFullYear() === curYear) thisMonth += amt;
            if (d.getFullYear() === curYear) thisYear += amt;
        }
    });
    document.getElementById('expense-total') && (document.getElementById('expense-total').innerText = total.toFixed(2));
    document.getElementById('expense-month') && (document.getElementById('expense-month').innerText = thisMonth.toFixed(2));
    document.getElementById('expense-year') && (document.getElementById('expense-year').innerText = thisYear.toFixed(2));
}
function updateTransactionSummary() {
    let totalIncome = 0, totalExpense = 0;
    incomeRecords.forEach(inc => totalIncome += parseFloat(inc.amount) || 0);
    expenseRecords.forEach(exp => totalExpense += parseFloat(exp.amount) || 0);
    let net = totalIncome - totalExpense;
    document.getElementById('trans-total-income') && (document.getElementById('trans-total-income').innerText = totalIncome.toFixed(2));
    document.getElementById('trans-total-expense') && (document.getElementById('trans-total-expense').innerText = totalExpense.toFixed(2));
    document.getElementById('trans-net-balance') && (document.getElementById('trans-net-balance').innerText = net.toFixed(2));
}

// Render Work Orders Table
function renderWorkOrders() {
    let tbody = document.getElementById('workorder-table-body');
    if (!tbody) return;
    tbody.innerHTML = '';
    if (workOrders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="no-data">No work orders recorded</td></tr>';
    } else {
        workOrders.forEach((wo, index) => {
            let profit = (parseFloat(wo.value) || 0) - (parseFloat(wo.cost) || 0);
            tbody.innerHTML += `<tr>
                <td>${index+1}</td>
                <td>${wo.client || ''}</td>
                <td>${wo.date || ''}</td>
                <td>${wo.type || ''}</td>
                <td>${(parseFloat(wo.value)||0).toFixed(2)}</td>
                <td>${(parseFloat(wo.cost)||0).toFixed(2)}</td>
                <td>${profit.toFixed(2)}</td>
                <td style="text-align:center;">
                    <button class="action-btn edit-btn" onclick="editWorkOrder(${index})">Edit</button>
                    <button class="action-btn del-btn" onclick="deleteWorkOrder(${index})">Del</button>
                </td>
            </tr>`;
        });
    }
    updateWorkOrderSummary();
}
function showWorkOrderModal(editIndex = null) {
    document.getElementById('editWorkOrderIndex').value = editIndex !== null ? editIndex : '';
    if (editIndex !== null) {
        let wo = workOrders[editIndex];
        document.getElementById('woClient').value = wo.client || '';
        document.getElementById('woDate').value = wo.date || '';
        document.getElementById('woType').value = wo.type || '';
        document.getElementById('woValue').value = wo.value || 0;
        document.getElementById('woCost').value = wo.cost || 0;
    } else {
        document.getElementById('woClient').value = '';
        document.getElementById('woDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('woType').value = '';
        document.getElementById('woValue').value = 0;
        document.getElementById('woCost').value = 0;
    }
    updateProfitCalc();
    document.getElementById('workOrderModal').style.display = 'block';
}
function closeWorkOrderModal() { document.getElementById('workOrderModal').style.display = 'none'; }
function updateProfitCalc() {
    let val = parseFloat(document.getElementById('woValue').value) || 0;
    let cost = parseFloat(document.getElementById('woCost').value) || 0;
    document.getElementById('woProfit').value = (val - cost).toFixed(2);
}
document.getElementById('woValue')?.addEventListener('input', updateProfitCalc);
document.getElementById('woCost')?.addEventListener('input', updateProfitCalc);
function saveWorkOrder() {
    let idx = document.getElementById('editWorkOrderIndex').value;
    let wo = {
        client: document.getElementById('woClient').value.trim(),
        date: document.getElementById('woDate').value,
        type: document.getElementById('woType').value.trim(),
        value: parseFloat(document.getElementById('woValue').value) || 0,
        cost: parseFloat(document.getElementById('woCost').value) || 0
    };
    if (!wo.client || !wo.date) return alert('Client and Date required');
    if (idx !== '') workOrders[idx] = wo; else workOrders.push(wo);
    saveWorkOrdersToStorage();
    renderWorkOrders();
    renderTransactions(); 
    closeWorkOrderModal();
    showToast('Work Order saved');
}
function editWorkOrder(index) { showWorkOrderModal(index); }
function deleteWorkOrder(index) { 
    if(confirm('Delete this Work Order?')) { 
        workOrders.splice(index,1); 
        saveWorkOrdersToStorage(); 
        renderWorkOrders(); 
        renderTransactions(); 
        showToast('Deleted'); 
    } 
}

// Render Income Table
function renderIncome() {
    let tbody = document.getElementById('income-table-body');
    if (!tbody) return;
    tbody.innerHTML = '';
    if (incomeRecords.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="no-data">No income recorded</td></tr>';
    } else {
        incomeRecords.forEach((inc, i) => {
            tbody.innerHTML += `<tr>
                <td>${i+1}</td>
                <td>${inc.date || ''}</td>
                <td>${inc.purpose || ''}</td>
                <td>${(parseFloat(inc.amount)||0).toFixed(2)}</td>
                <td style="text-align:center;">
                    <button class="action-btn edit-btn" onclick="editIncome(${i})">Edit</button>
                    <button class="action-btn del-btn" onclick="deleteIncome(${i})">Del</button>
                </td>
            </tr>`;
        });
    }
    updateIncomeSummary();
}
function showIncomeModal(editIndex = null) {
    document.getElementById('editIncomeIndex').value = editIndex !== null ? editIndex : '';
    if (editIndex !== null) {
        let inc = incomeRecords[editIndex];
        document.getElementById('incomeDate').value = inc.date || '';
        document.getElementById('incomePurpose').value = inc.purpose || '';
        document.getElementById('incomeAmount').value = inc.amount || 0;
    } else {
        document.getElementById('incomeDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('incomePurpose').value = '';
        document.getElementById('incomeAmount').value = 0;
    }
    document.getElementById('incomeModal').style.display = 'block';
}
function closeIncomeModal() { document.getElementById('incomeModal').style.display = 'none'; }
function saveIncome() {
    let idx = document.getElementById('editIncomeIndex').value;
    let inc = {
        date: document.getElementById('incomeDate').value,
        purpose: document.getElementById('incomePurpose').value.trim(),
        amount: parseFloat(document.getElementById('incomeAmount').value) || 0
    };
    if (!inc.date || !inc.purpose) return alert('Date and Purpose required');
    if (idx !== '') incomeRecords[idx] = inc; else incomeRecords.push(inc);
    saveIncomeToStorage();
    renderIncome();
    renderTransactions();
    closeIncomeModal();
    showToast('Income saved');
}
function editIncome(index) { showIncomeModal(index); }
function deleteIncome(index) { 
    if(confirm('Delete this Income Record?')) { 
        incomeRecords.splice(index,1); 
        saveIncomeToStorage(); 
        renderIncome(); 
        renderTransactions(); 
        showToast('Deleted'); 
    } 
}

// Render Expense Table
function renderExpense() {
    let tbody = document.getElementById('expense-table-body');
    if (!tbody) return;
    tbody.innerHTML = '';
    if (expenseRecords.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="no-data">No expenses recorded</td></tr>';
    } else {
        expenseRecords.forEach((exp, i) => {
            tbody.innerHTML += `<tr>
                <td>${i+1}</td>
                <td>${exp.date || ''}</td>
                <td>${exp.purpose || ''}</td>
                <td>${(parseFloat(exp.amount)||0).toFixed(2)}</td>
                <td style="text-align:center;">
                    <button class="action-btn edit-btn" onclick="editExpense(${i})">Edit</button>
                    <button class="action-btn del-btn" onclick="deleteExpense(${i})">Del</button>
                </td>
            </tr>`;
        });
    }
    updateExpenseSummary();
}
function showExpenseModal(editIndex = null) {
    document.getElementById('editExpenseIndex').value = editIndex !== null ? editIndex : '';
    if (editIndex !== null) {
        let exp = expenseRecords[editIndex];
        document.getElementById('expenseDate').value = exp.date || '';
        document.getElementById('expensePurpose').value = exp.purpose || '';
        document.getElementById('expenseAmount').value = exp.amount || 0;
    } else {
        document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('expensePurpose').value = '';
        document.getElementById('expenseAmount').value = 0;
    }
    document.getElementById('expenseModal').style.display = 'block';
}
function closeExpenseModal() { document.getElementById('expenseModal').style.display = 'none'; }
function saveExpense() {
    let idx = document.getElementById('editExpenseIndex').value;
    let exp = {
        date: document.getElementById('expenseDate').value,
        purpose: document.getElementById('expensePurpose').value.trim(),
        amount: parseFloat(document.getElementById('expenseAmount').value) || 0
    };
    if (!exp.date || !exp.purpose) return alert('Date and Purpose required');
    if (idx !== '') expenseRecords[idx] = exp; else expenseRecords.push(exp);
    saveExpenseToStorage();
    renderExpense();
    renderTransactions();
    closeExpenseModal();
    showToast('Expense saved');
}
function editExpense(index) { showExpenseModal(index); }
function deleteExpense(index) { 
    if(confirm('Delete this Expense Record?')) { 
        expenseRecords.splice(index,1); 
        saveExpenseToStorage(); 
        renderExpense(); 
        renderTransactions(); 
        showToast('Deleted'); 
    } 
}

// Render Transactions (combined from income & expense)
function renderTransactions() {
    let tbody = document.getElementById('transaction-table-body');
    if (!tbody) return;
    let transactions = [];
    incomeRecords.forEach(inc => {
        transactions.push({ date: inc.date, type: 'Income', desc: inc.purpose, credit: inc.amount, debit: 0, sort: new Date(inc.date) });
    });
    expenseRecords.forEach(exp => {
        transactions.push({ date: exp.date, type: 'Expense', desc: exp.purpose, credit: 0, debit: exp.amount, sort: new Date(exp.date) });
    });
    transactions.sort((a,b) => a.sort - b.sort);
    tbody.innerHTML = '';
    if (transactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="no-data">No transactions yet</td></tr>';
        document.getElementById('transaction-balance').innerText = '0.00';
    } else {
        let balance = 0;
        transactions.forEach((t, i) => {
            balance = balance + (t.credit || 0) - (t.debit || 0);
            tbody.innerHTML += `<tr>
                <td>${t.date || ''}</td>
                <td><span style="color:${t.type==='Income'?'green':'red'};font-weight:bold;">${t.type}</span></td>
                <td>${t.desc}</td>
                <td>${t.credit > 0 ? t.credit.toFixed(2) : ''}</td>
                <td>${t.debit > 0 ? t.debit.toFixed(2) : ''}</td>
                <td>${balance.toFixed(2)}</td>
            </tr>`;
        });
        document.getElementById('transaction-balance').innerText = balance.toFixed(2);
    }
    updateTransactionSummary();
}

// ========== DOCUMENT READY ==========
document.addEventListener('DOMContentLoaded', () => {
    loadSettings();
    renderContacts('client');
    renderContacts('supplier');
    loadQuotations(); 
    renderProducts(); 
    renderInventory(); 
    loadPurchaseOrders(); 
    loadInvoices(); loadDeliveryChallans(); loadMoneyReceipts(); loadLetters();
    workOrders = JSON.parse(localStorage.getItem('ArvinWorkOrders') || '[]');
    incomeRecords = JSON.parse(localStorage.getItem('ArvinIncomeRecords') || '[]');
    expenseRecords = JSON.parse(localStorage.getItem('ArvinExpenseRecords') || '[]');
    renderWorkOrders();
    renderIncome();
    renderExpense();
    renderTransactions();
});

// Tab Navigation
function openTab(tabName) {
    document.getElementById('folder-grid').style.display = "none";
    var i, tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) tabcontent[i].style.display = "none";
    const target = document.getElementById(tabName);
    if(target) target.style.display = "block";
    window.scrollTo({top: 0, behavior: 'smooth'});
    if (tabName === 'quotation-tab') loadQuotations();
    if (tabName === 'products-tab') renderProducts();
    if (tabName === 'inventory-tab') renderInventory();
    if (tabName === 'purchase-tab') loadPurchaseOrders();
    if (tabName === 'invoice-tab') loadInvoices();
    if (tabName === 'delivery-tab') loadDeliveryChallans();
    if (tabName === 'receipt-tab') loadMoneyReceipts();
    if (tabName === 'letter-tab') loadLetters();
    if (tabName === 'accounts-tab') {
        // no need to show sub content inside main tab ‚Äì popup only
    }
}

function closeTabs() {
    document.getElementById('folder-grid').style.display = "grid";
    var i, tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) tabcontent[i].style.display = "none";
    window.scrollTo({top: 0, behavior: 'smooth'});
}

// ===== ACCOUNTS SUB POPUP: displays full content in a new professional window =====
function openAccountsSubPopup(subId) {
    const sourceDiv = document.getElementById(subId);
    if (!sourceDiv) return;
    
    const cloneContent = sourceDiv.cloneNode(true);
    cloneContent.style.display = 'block';
    cloneContent.classList.remove('accounts-sub-content');
    cloneContent.classList.add('accounts-sub-content');
    
    const popupInner = document.getElementById('accountsPopupInner');
    popupInner.innerHTML = '';
    popupInner.appendChild(cloneContent);
    
    const popupContentDiv = document.getElementById('accountsPopupContent');
    let borderColor = '';
    if (subId === 'accounts-workorder') borderColor = 'var(--accounts-workorder)';
    else if (subId === 'accounts-income') borderColor = 'var(--accounts-income)';
    else if (subId === 'accounts-expense') borderColor = 'var(--accounts-expense)';
    else if (subId === 'accounts-transaction') borderColor = 'var(--accounts-transaction)';
    popupContentDiv.style.borderTopColor = borderColor;
    
    document.getElementById('accountsSubPopupModal').style.display = 'block';
    
    if (subId === 'accounts-workorder') renderWorkOrders();
    if (subId === 'accounts-income') renderIncome();
    if (subId === 'accounts-expense') renderExpense();
    if (subId === 'accounts-transaction') renderTransactions();
}

function closeAccountsSubPopup() {
    document.getElementById('accountsSubPopupModal').style.display = 'none';
}

// ========== CONTACTS (CLIENTS/SUPPLIERS) ==========
function showContactModal(type, index = null) {
    const modal = document.getElementById('contactModal');
    document.getElementById('modalType').value = type;
    document.getElementById('editIndex').value = index !== null ? index : '';
    document.getElementById('modalTitle').innerText = (index!==null?'Edit ':'Add ') + (type==='client'?'Client':'Supplier');
    document.getElementById('nameLabel').innerText = type==='client'?'Client Name':'Supplier Name';
    if (index !== null) {
        const data = JSON.parse(localStorage.getItem(type==='client'?'ArvinClients':'ArvinSuppliers'))[index];
        document.getElementById('modalName').value = data.name || '';
        document.getElementById('modalAddress').value = data.address || '';
        document.getElementById('modalPerson').value = data.person || '';
        document.getElementById('modalDesignation').value = data.designation || '';
        document.getElementById('modalMobile').value = data.mobile || '';
        document.getElementById('modalEmail').value = data.email || '';
    } else { clearModalInputs(); }
    modal.style.display = "block";
}
function closeContactModal() { document.getElementById('contactModal').style.display = "none"; }
function clearModalInputs() {
    ['modalName','modalAddress','modalPerson','modalDesignation','modalMobile','modalEmail'].forEach(id=>document.getElementById(id).value='');
}
function saveContact() {
    const type = document.getElementById('modalType').value, index = document.getElementById('editIndex').value;
    const storageKey = type === 'client' ? 'ArvinClients' : 'ArvinSuppliers';
    const contact = {
        name: document.getElementById('modalName').value.trim(),
        address: document.getElementById('modalAddress').value.trim(),
        person: document.getElementById('modalPerson').value.trim(),
        designation: document.getElementById('modalDesignation').value.trim(),
        mobile: document.getElementById('modalMobile').value.trim(),
        email: document.getElementById('modalEmail').value.trim().toLowerCase()
    };
    if(!contact.name) { alert("Name required"); return; }
    let list = JSON.parse(localStorage.getItem(storageKey) || '[]');
    if (index !== '') list[index] = contact; else list.push(contact);
    localStorage.setItem(storageKey, JSON.stringify(list));
    renderContacts(type);
    closeContactModal();
    showToast((type==='client'?'Client':'Supplier')+' saved!');
}
function deleteContact(type, index) {
    if(confirm("Delete this " + (type==='client'?'Client':'Supplier') + "?")) {
        let list = JSON.parse(localStorage.getItem(type==='client'?'ArvinClients':'ArvinSuppliers') || '[]');
        list.splice(index,1);
        localStorage.setItem(type==='client'?'ArvinClients':'ArvinSuppliers', JSON.stringify(list));
        renderContacts(type);
        showToast('Deleted');
    }
}
function renderContacts(type) {
    const storageKey = type === 'client' ? 'ArvinClients' : 'ArvinSuppliers';
    const tbody = document.getElementById(type === 'client' ? 'clientTableBody' : 'supplierTableBody');
    const list = JSON.parse(localStorage.getItem(storageKey) || '[]');
    const searchTerm = (document.getElementById(type==='client'?'clientSearch':'supplierSearch')?.value || '').toLowerCase();
    const filtered = list.filter(item => 
        item.name?.toLowerCase().includes(searchTerm) ||
        item.person?.toLowerCase().includes(searchTerm) ||
        item.email?.toLowerCase().includes(searchTerm) ||
        item.mobile?.includes(searchTerm)
    );
    tbody.innerHTML = '';
    if (filtered.length===0) { tbody.innerHTML = `<tr><td colspan="6" class="no-data">No ${type}s found</td></tr>`; return; }
    filtered.forEach((item, index) => {
        const originalIndex = list.findIndex(c => c===item);
        tbody.innerHTML += `<tr>
            <td>${index+1}</td>
            <td><strong>${item.name||''}</strong><br><small>${item.address||''}</small></td>
            <td>${item.person||''}<br><small>${item.designation||''}</small></td>
            <td><a href="tel:${item.mobile||''}" style="color:var(--fire-red);">${item.mobile||''}</a></td>
            <td><a href="mailto:${item.email||''}" style="color:var(--accent-blue);">${item.email||''}</a></td>
            <td><button class="action-btn edit-btn" onclick="showContactModal('${type}', ${originalIndex})">Edit</button>
                <button class="action-btn del-btn" onclick="deleteContact('${type}', ${originalIndex})">Del</button></td>
        </tr>`;
    });
}

// ========== PRODUCTS with Stock ==========
function renderProducts() {
    const products = JSON.parse(localStorage.getItem('ArvinProducts') || '[]');
    const tbody = document.getElementById('productTableBody');
    if(!tbody) return;
    const searchTerm = document.getElementById('productSearch')?.value.toLowerCase() || '';
    const filtered = products.filter(p => 
        p.name?.toLowerCase().includes(searchTerm) || 
        p.description?.toLowerCase().includes(searchTerm)
    );
    tbody.innerHTML = '';
    if(filtered.length===0) { tbody.innerHTML = '<tr><td colspan="7" class="no-data">No products.</td></tr>'; return; }
    filtered.forEach((p,idx)=>{
        const originalIndex = products.findIndex(prod => prod === p);
        tbody.innerHTML += `<tr>
            <td>${idx+1}</td>
            <td>${p.name}</td>
            <td>${p.description}</td>
            <td>${p.unit}</td>
            <td>${p.currency || '‚Çπ'}${parseFloat(p.price).toFixed(2)}</td>
            <td>${p.stockQty !== undefined ? p.stockQty : 0}</td>
            <td>
                <button class="action-btn edit-btn" onclick="editProduct(${originalIndex})">Edit</button>
                <button class="action-btn del-btn" onclick="deleteProduct(${originalIndex})">Del</button>
            </td>
        </tr>`;
    });
}
function showProductModal() {
    document.getElementById('editProductIndex').value = '';
    document.getElementById('productName').value = '';
    document.getElementById('productDesc').value = '';
    document.getElementById('productUnit').value = '';
    document.getElementById('productPrice').value = '';
    document.getElementById('productStock').value = 0;
    document.getElementById('productModal').style.display = 'block';
}
function closeProductModal() { document.getElementById('productModal').style.display = 'none'; }
function saveProduct() {
    const idx = document.getElementById('editProductIndex').value;
    let settings = JSON.parse(localStorage.getItem('ArvinSettings') || '{}');
    const product = {
        name: document.getElementById('productName').value.trim(),
        description: document.getElementById('productDesc').value.trim(),
        unit: document.getElementById('productUnit').value.trim(),
        price: parseFloat(document.getElementById('productPrice').value) || 0,
        stockQty: parseInt(document.getElementById('productStock').value) || 0,
        currency: settings.currency || '‚Çπ'
    };
    if(!product.name) return alert('Name required');
    let prods = JSON.parse(localStorage.getItem('ArvinProducts') || '[]');
    if(idx!=='') prods[idx] = product; else prods.push(product);
    localStorage.setItem('ArvinProducts', JSON.stringify(prods));
    renderProducts(); renderInventory(); closeProductModal(); showToast('Product saved');
}
function editProduct(idx) {
    let prods = JSON.parse(localStorage.getItem('ArvinProducts') || '[]');
    let p = prods[idx];
    document.getElementById('editProductIndex').value = idx;
    document.getElementById('productName').value = p.name;
    document.getElementById('productDesc').value = p.description;
    document.getElementById('productUnit').value = p.unit;
    document.getElementById('productPrice').value = p.price;
    document.getElementById('productStock').value = p.stockQty || 0;
    document.getElementById('productModal').style.display = 'block';
}
function deleteProduct(idx) {
    if(confirm('Delete this Product?')){
        let prods = JSON.parse(localStorage.getItem('ArvinProducts') || '[]');
        prods.splice(idx,1);
        localStorage.setItem('ArvinProducts', JSON.stringify(prods));
        renderProducts(); renderInventory();
        showToast('Deleted');
    }
}

// ========== INVENTORY from Products ==========
function renderInventory() {
    const products = JSON.parse(localStorage.getItem('ArvinProducts') || '[]');
    const tbody = document.getElementById('inventoryTableBody');
    const noMsg = document.getElementById('noInventoryMsg');
    if (!tbody) return;
    const searchTerm = document.getElementById('inventorySearch')?.value.toLowerCase() || '';
    const filtered = products.filter(p => 
        p.name?.toLowerCase().includes(searchTerm) || 
        p.description?.toLowerCase().includes(searchTerm)
    );
    tbody.innerHTML = '';
    if(filtered.length===0) { 
        tbody.innerHTML = '<tr><td colspan="4" class="no-data">No inventory items</td></tr>'; 
        if(noMsg) noMsg.style.display = 'none';
        return; 
    }
    if(noMsg) noMsg.style.display = 'none';
    filtered.forEach((p, idx) => {
        tbody.innerHTML += `<tr>
            <td>${idx+1}</td>
            <td>${p.name}</td>
            <td>${p.description}</td>
            <td>${p.stockQty !== undefined ? p.stockQty : 0}</td>
        </tr>`;
    });
}

// ========== SUGGESTIONS ==========
function showProductSuggestions() {
    const input = document.getElementById('itemName'), query = input.value.toLowerCase(), div = document.getElementById('productSuggestions');
    if (query.length < 1) { div.style.display = 'none'; return; }
    const products = JSON.parse(localStorage.getItem('ArvinProducts') || '[]');
    const filtered = products.filter(p => p.name.toLowerCase().includes(query));
    if (filtered.length===0) { div.style.display = 'none'; return; }
    div.innerHTML = filtered.map(p => `<div class="suggestion-item" onclick="selectProduct('${p.name.replace(/'/g, "\\'")}', '${p.description.replace(/'/g, "\\'")}', '${p.unit}', ${p.price})"><strong>${p.name}</strong></div>`).join('');
    div.style.display = 'block';
    const rect = input.getBoundingClientRect();
    div.style.top = (rect.bottom + window.scrollY) + 'px'; div.style.left = (rect.left + window.scrollX) + 'px'; div.style.width = rect.width + 'px';
}
function selectProduct(name, desc, unit, price) {
    document.getElementById('itemName').value = name;
    document.getElementById('itemDescription').value = desc;
    document.getElementById('itemUnit').value = unit;
    if(document.getElementById('itemUnitPrice')) document.getElementById('itemUnitPrice').value = price;
    document.getElementById('productSuggestions').style.display = 'none';
}
function showClientSuggestions(context) {
    let inputId, suggId;
    if(context === 'invoice') { inputId='invoiceClient'; suggId='invoiceClientSuggestions'; }
    else if(context === 'delivery') { inputId='deliveryClient'; suggId='deliveryClientSuggestions'; }
    else if(context === 'receipt') { inputId='receiptClient'; suggId='receiptClientSuggestions'; }
    else { inputId='quotationClient'; suggId='clientSuggestions'; }
    const input = document.getElementById(inputId), query = input.value.toLowerCase(), div = document.getElementById(suggId);
    if (query.length < 1) { div.style.display = 'none'; return; }
    const clients = JSON.parse(localStorage.getItem('ArvinClients') || '[]');
    const filtered = clients.filter(c => c.name.toLowerCase().includes(query));
    if (filtered.length===0) { div.style.display = 'none'; return; }
    div.innerHTML = filtered.map(c => `<div class="suggestion-item" onclick="selectClient('${c.name.replace(/'/g, "\\'")}', '${c.address.replace(/'/g, "\\'")}', '${context}')"><strong>${c.name}</strong></div>`).join('');
    div.style.display = 'block';
    const rect = input.getBoundingClientRect();
    div.style.top = (rect.bottom + window.scrollY)+'px'; div.style.left = (rect.left + window.scrollX)+'px'; div.style.width = rect.width+'px';
}
function selectClient(name, address, context) {
    if(context === 'invoice') { document.getElementById('invoiceClient').value = name; document.getElementById('invoiceAddress').value = address; document.getElementById('invoiceClientSuggestions').style.display='none'; }
    else if(context === 'delivery') { document.getElementById('deliveryClient').value = name; document.getElementById('deliveryAddress').value = address; document.getElementById('deliveryClientSuggestions').style.display='none'; }
    else if(context === 'receipt') { document.getElementById('receiptClient').value = name; document.getElementById('receiptAddress').value = address; document.getElementById('receiptClientSuggestions').style.display='none'; }
    else { document.getElementById('quotationClient').value = name; document.getElementById('quotationAddress').value = address; document.getElementById('clientSuggestions').style.display='none'; }
}
function showSupplierSuggestions(context) {
    let input = document.getElementById('poSupplier'), sugg = document.getElementById('poSupplierSuggestions');
    const query = input.value.toLowerCase();
    if(query.length<1) { sugg.style.display='none'; return; }
    const suppliers = JSON.parse(localStorage.getItem('ArvinSuppliers') || '[]');
    const filtered = suppliers.filter(s => s.name.toLowerCase().includes(query));
    if(filtered.length===0) { sugg.style.display='none'; return; }
    sugg.innerHTML = filtered.map(s => `<div class="suggestion-item" onclick="selectSupplier('${s.name.replace(/'/g, "\\'")}', '${s.address.replace(/'/g, "\\'")}')"><strong>${s.name}</strong></div>`).join('');
    sugg.style.display='block';
    const rect = input.getBoundingClientRect();
    sugg.style.top = (rect.bottom + window.scrollY)+'px'; sugg.style.left = (rect.left+window.scrollX)+'px'; sugg.style.width = rect.width+'px';
}
function selectSupplier(name, address) {
    document.getElementById('poSupplier').value = name;
    document.getElementById('poAddress').value = address;
    document.getElementById('poSupplierSuggestions').style.display='none';
}

// ========== QUOTATION LOGIC ==========
let quotationItems = [];
function showQuotationModal(editIndex = null) { 
    const modal = document.getElementById('quotationModal');
    document.getElementById('editQuotationIndex').value = editIndex !== null ? editIndex : '';
    document.getElementById('quotationModalTitle').innerText = editIndex !== null ? 'Edit Quotation' : 'New Quotation';
    if (editIndex !== null) {
        let quotes = JSON.parse(localStorage.getItem('ArvinQuotations') || '[]');
        let q = quotes[editIndex];
        document.getElementById('quotationClient').value = q.client || '';
        document.getElementById('quotationAddress').value = q.address || '';
        document.getElementById('quotationId').value = q.id;
        document.getElementById('quotationRef').value = q.reference || '';
        document.getElementById('quotationDate').value = q.date;
        document.getElementById('quotationSubject').value = q.subject || '';
        document.getElementById('quotationVATPercent').value = q.vatPercent || 0;
        document.getElementById('quotationAITPercent').value = q.aitPercent || 0;
        document.getElementById('quotationNotes').value = q.notes || '';
        quotationItems = q.items ? [...q.items] : [];
    } else {
        document.getElementById('quotationClient').value = ''; 
        document.getElementById('quotationAddress').value = '';
        document.getElementById('quotationRef').value = '';
        document.getElementById('quotationSubject').value = '';
        document.getElementById('quotationVATPercent').value = 0;
        document.getElementById('quotationAITPercent').value = 0;
        document.getElementById('quotationNotes').value = '';
        let qList = JSON.parse(localStorage.getItem('ArvinQuotations') || '[]');
        let lastIdNum = qList.length > 0 ? parseInt(qList[qList.length-1].id.split('-')[2]) : 100100;
        document.getElementById('quotationId').value = `AC-Q-${lastIdNum+1}`;
        document.getElementById('quotationDate').value = new Date().toISOString().split('T')[0];
        quotationItems = [];
    }
    renderQuotationItems();
    calculateQuotationGrandTotal();
    modal.style.display = "block";
}
function closeQuotationModal() { document.getElementById('quotationModal').style.display = "none"; }
function addQuotationItem() { 
    document.getElementById('itemContext').value='quotation'; 
    document.getElementById('itemModalTitle').innerText='Add Quotation Item'; 
    document.getElementById('itemPriceGroup').style.display='block'; 
    document.getElementById('itemRemarksGroup').style.display='none'; 
    clearItemFields(); 
    document.getElementById('itemModal').style.display='block'; 
}
function renderQuotationItems() { 
    let tbody = document.getElementById('quotationItemsTable'), settings = JSON.parse(localStorage.getItem('ArvinSettings') || '{}');
    tbody.innerHTML = '';
    if(quotationItems.length===0) { tbody.innerHTML = '<tr><td colspan="8" class="no-data">No items</td></tr>'; return; }
    quotationItems.forEach((item,i)=>{
        let total = item.quantity * item.unitPrice;
        tbody.innerHTML += `<tr><td>${i+1}</td><td>${item.name}</td><td>${item.description}</td><td>${item.quantity}</td><td>${item.unit}</td><td>${settings.currency || '‚Çπ'}${item.unitPrice.toFixed(2)}</td><td>${settings.currency || '‚Çπ'}${total.toFixed(2)}</td><td><button class="action-btn edit-btn" onclick="editQuotationItem(${i})">Edit</button><button class="action-btn del-btn" onclick="deleteQuotationItem(${i})">Del</button></td></tr>`;
    });
}
function editQuotationItem(i) {
    let item = quotationItems[i];
    document.getElementById('itemContext').value='quotation';
    document.getElementById('editItemIndex').value = i;
    document.getElementById('itemName').value = item.name;
    document.getElementById('itemDescription').value = item.description;
    document.getElementById('itemQuantity').value = item.quantity;
    document.getElementById('itemUnit').value = item.unit;
    document.getElementById('itemUnitPrice').value = item.unitPrice;
    document.getElementById('itemPriceGroup').style.display='block'; 
    document.getElementById('itemRemarksGroup').style.display='none';
    document.getElementById('itemModal').style.display = "block";
}
function deleteQuotationItem(i) { quotationItems.splice(i,1); renderQuotationItems(); calculateQuotationGrandTotal(); }
function calculateQuotationGrandTotal() { 
    let subtotal = quotationItems.reduce((s,it)=> s + (it.quantity*it.unitPrice), 0); 
    let vatPercent = parseFloat(document.getElementById('quotationVATPercent').value) || 0;
    let aitPercent = parseFloat(document.getElementById('quotationAITPercent').value) || 0;
    let vat = subtotal * vatPercent / 100;
    let ait = subtotal * aitPercent / 100;
    let grandTotal = subtotal + vat + ait;
    document.getElementById('quotationGrandTotalDisplay').innerText = grandTotal.toFixed(2);
    return grandTotal;
}
function saveQuotation() {
    let editIdx = document.getElementById('editQuotationIndex').value;
    let quotation = {
        id: document.getElementById('quotationId').value,
        client: document.getElementById('quotationClient').value.trim(),
        address: document.getElementById('quotationAddress').value.trim(),
        reference: document.getElementById('quotationRef').value.trim(),
        date: document.getElementById('quotationDate').value,
        subject: document.getElementById('quotationSubject').value.trim(),
        notes: document.getElementById('quotationNotes').value.trim(),
        items: [...quotationItems],
        vatPercent: parseFloat(document.getElementById('quotationVATPercent').value) || 0,
        aitPercent: parseFloat(document.getElementById('quotationAITPercent').value) || 0,
        grandTotal: calculateQuotationGrandTotal()
    };
    if(!quotation.client || !quotation.date) return alert("Client and date required");
    let quotes = JSON.parse(localStorage.getItem('ArvinQuotations') || '[]');
    if(editIdx!=='') quotes[editIdx] = quotation; else quotes.push(quotation);
    localStorage.setItem('ArvinQuotations', JSON.stringify(quotes));
    loadQuotations(); closeQuotationModal(); showToast('Quotation saved');
}

// NEW FUNCTION: Convert Quotation to Invoice
function convertQuotationToInvoice(quotationIndex) {
    let quotes = JSON.parse(localStorage.getItem('ArvinQuotations') || '[]');
    let q = quotes[quotationIndex];
    
    // Prepare invoice items from quotation items
    let invoiceItemsData = q.items.map(item => ({
        name: item.name,
        description: item.description,
        quantity: item.quantity,
        unit: item.unit,
        unitPrice: item.unitPrice
    }));
    
    // Get last invoice number
    let invoices = JSON.parse(localStorage.getItem('ArvinInvoices') || '[]');
    let lastNum = invoices.length > 0 ? parseInt(invoices[invoices.length-1].invoiceNo.split('-')[2]) : 100100;
    let newInvoiceNo = `AC-INV-${lastNum+1}`;
    
    // Create invoice object
    let invoice = {
        client: q.client,
        address: q.address,
        invoiceNo: newInvoiceNo,
        orderId: q.reference || '',
        date: new Date().toISOString().split('T')[0],
        subject: 'Invoice from Quotation: ' + q.id,
        items: invoiceItemsData,
        grandTotal: q.grandTotal,
        paid: 0,
        due: q.grandTotal,
        notes: q.notes || ''
    };
    
    invoices.push(invoice);
    localStorage.setItem('ArvinInvoices', JSON.stringify(invoices));
    showToast('Quotation converted to Invoice successfully');
    loadInvoices();
}

// NEW FUNCTION: Convert Quotation to Delivery Challan
function convertQuotationToDelivery(quotationIndex) {
    let quotes = JSON.parse(localStorage.getItem('ArvinQuotations') || '[]');
    let q = quotes[quotationIndex];
    
    // Prepare delivery items from quotation items (no prices)
    let deliveryItemsData = q.items.map(item => ({
        name: item.name,
        description: item.description,
        quantity: item.quantity,
        unit: item.unit,
        remarks: ''
    }));
    
    // Get last delivery number
    let deliveries = JSON.parse(localStorage.getItem('ArvinDeliveries') || '[]');
    let lastNum = deliveries.length > 0 ? parseInt(deliveries[deliveries.length-1].deliveryNo.split('-')[2]) : 100100;
    let newDeliveryNo = `AC-DC-${lastNum+1}`;
    
    // Create delivery challan object
    let delivery = {
        client: q.client,
        address: q.address,
        deliveryNo: newDeliveryNo,
        orderId: q.reference || '',
        gatePass: '',
        date: new Date().toISOString().split('T')[0],
        items: deliveryItemsData
    };
    
    deliveries.push(delivery);
    localStorage.setItem('ArvinDeliveries', JSON.stringify(deliveries));
    showToast('Quotation converted to Delivery Challan successfully');
    loadDeliveryChallans();
}

function loadQuotations() { 
    let container = document.getElementById('quotationsList'), noMsg = document.getElementById('noQuotationsMsg');
    let quotes = JSON.parse(localStorage.getItem('ArvinQuotations') || '[]');
    container.innerHTML = '';
    if(quotes.length===0) { noMsg.style.display='block'; return; }
    noMsg.style.display='none';
    quotes.slice().reverse().forEach((q, idx)=>{
        let actualIndex = quotes.length-1-idx;
        let card = document.createElement('div'); card.className = 'doc-card';
        let settings = JSON.parse(localStorage.getItem('ArvinSettings') || '{}');
        let currency = settings.currency || '‚Çπ';
        card.innerHTML = `
            <h3 style="margin:0 0 8px 0; color:var(--fire-red);">${q.id}</h3>
            <p style="margin:5px 0; font-size:15px; font-weight:bold;">${q.client}</p>
            <p style="margin:5px 0; color:#555;">Date: ${q.date} | Total: ${currency}${(q.grandTotal || 0).toFixed(2)}</p>
            <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
                <button class="action-btn edit-btn" onclick="showQuotationModal(${actualIndex})">Edit</button>
                <button class="action-btn del-btn" onclick="deleteQuotation(${actualIndex})">Del</button>
                <button class="action-btn convert-btn" onclick="convertQuotationToInvoice(${actualIndex})" style="background:#27ae60;">‚Üí Invoice</button>
                <button class="action-btn convert-btn" onclick="convertQuotationToDelivery(${actualIndex})" style="background:#1abc9c;">‚Üí Delivery</button>
                <button class="action-btn" style="background:var(--success-green);color:white;" onclick="printQuotation(${actualIndex})">Print PDF</button>
            </div>
        `;
        container.appendChild(card);
    });
}
function deleteQuotation(i) { 
    if(confirm('Delete this Quotation?')){ 
        let q = JSON.parse(localStorage.getItem('ArvinQuotations')); 
        q.splice(i,1); 
        localStorage.setItem('ArvinQuotations',JSON.stringify(q)); 
        loadQuotations(); 
        showToast('Deleted');
    } 
}

// ========== INVOICE ==========
let invoiceItems = [];
function showInvoiceModal(editIdx=null) {
    const modal = document.getElementById('invoiceModal');
    document.getElementById('editInvoiceIndex').value = editIdx!==null?editIdx:'';
    document.getElementById('invoiceModalTitle').innerText = editIdx!==null?'Edit Invoice':'New Invoice';
    document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
    if(editIdx!==null){
        let invs = JSON.parse(localStorage.getItem('ArvinInvoices')||'[]');
        let inv = invs[editIdx];
        document.getElementById('invoiceClient').value = inv.client||'';
        document.getElementById('invoiceAddress').value = inv.address||'';
        document.getElementById('invoiceNo').value = inv.invoiceNo;
        document.getElementById('invoiceOrderId').value = inv.orderId||'';
        document.getElementById('invoiceDate').value = inv.date;
        document.getElementById('invoiceSubject').value = inv.subject||'';
        document.getElementById('invoicePaid').value = inv.paid||0;
        document.getElementById('invoiceDue').value = inv.due||0;
        document.getElementById('invoiceNotes').value = inv.notes||'';
        invoiceItems = inv.items?[...inv.items]:[];
    } else {
        let invList = JSON.parse(localStorage.getItem('ArvinInvoices')||'[]');
        let lastNum = invList.length>0? parseInt(invList[invList.length-1].invoiceNo.split('-')[2]) : 100100;
        document.getElementById('invoiceNo').value = `AC-INV-${lastNum+1}`;
        document.getElementById('invoiceClient').value=''; document.getElementById('invoiceAddress').value='';
        document.getElementById('invoiceOrderId').value=''; document.getElementById('invoiceSubject').value='';
        document.getElementById('invoicePaid').value=0; document.getElementById('invoiceDue').value=0;
        document.getElementById('invoiceNotes').value='';
        invoiceItems = [];
    }
    renderInvoiceItems(); calculateInvoiceTotal(); modal.style.display='block';
}
function closeInvoiceModal() { document.getElementById('invoiceModal').style.display='none'; }
function addInvoiceItem() { document.getElementById('itemContext').value='invoice'; document.getElementById('itemModalTitle').innerText='Add Invoice Item'; document.getElementById('itemPriceGroup').style.display='block'; document.getElementById('itemRemarksGroup').style.display='none'; clearItemFields(); document.getElementById('itemModal').style.display='block'; }
function renderInvoiceItems() {
    let tbody = document.getElementById('invoiceItemsTable'), settings = JSON.parse(localStorage.getItem('ArvinSettings')||'{}'), cur = settings.currency||'‚Çπ';
    tbody.innerHTML = '';
    if(invoiceItems.length===0) { tbody.innerHTML = '<tr><td colspan="8" class="no-data">No items</td></tr>'; return; }
    invoiceItems.forEach((it,i)=>{
        let total = it.quantity*it.unitPrice;
        tbody.innerHTML += `<tr><td>${i+1}</td><td>${it.name}</td><td>${it.description}</td><td>${it.quantity}</td><td>${it.unit}</td><td>${cur}${it.unitPrice.toFixed(2)}</td><td>${cur}${total.toFixed(2)}</td><td><button class="action-btn edit-btn" onclick="editInvoiceItem(${i})">Edit</button><button class="action-btn del-btn" onclick="deleteInvoiceItem(${i})">Del</button></td></tr>`;
    });
}
function editInvoiceItem(i) {
    let it = invoiceItems[i];
    document.getElementById('itemContext').value='invoice';
    document.getElementById('editItemIndex').value = i;
    document.getElementById('itemName').value = it.name;
    document.getElementById('itemDescription').value = it.description;
    document.getElementById('itemQuantity').value = it.quantity;
    document.getElementById('itemUnit').value = it.unit;
    document.getElementById('itemUnitPrice').value = it.unitPrice;
    document.getElementById('itemPriceGroup').style.display='block'; document.getElementById('itemRemarksGroup').style.display='none';
    document.getElementById('itemModal').style.display='block';
}
function deleteInvoiceItem(i) { invoiceItems.splice(i,1); renderInvoiceItems(); calculateInvoiceTotal(); }
function calculateInvoiceTotal() {
    let t = invoiceItems.reduce((s,it)=> s + (it.quantity*it.unitPrice),0);
    document.getElementById('invoiceGrandTotal').innerText = t.toFixed(2);
    updateInvoiceDue();
    return t;
}
function updateInvoiceDue() {
    let total = parseFloat(document.getElementById('invoiceGrandTotal').innerText)||0;
    let paid = parseFloat(document.getElementById('invoicePaid').value)||0;
    let due = Math.max(total-paid,0);
    document.getElementById('invoiceDue').value = due.toFixed(2);
}
function saveInvoice() {
    let idx = document.getElementById('editInvoiceIndex').value;
    let invoice = {
        client: document.getElementById('invoiceClient').value.trim(),
        address: document.getElementById('invoiceAddress').value.trim(),
        invoiceNo: document.getElementById('invoiceNo').value,
        orderId: document.getElementById('invoiceOrderId').value,
        date: document.getElementById('invoiceDate').value,
        subject: document.getElementById('invoiceSubject').value,
        items: invoiceItems,
        grandTotal: parseFloat(document.getElementById('invoiceGrandTotal').innerText)||0,
        paid: parseFloat(document.getElementById('invoicePaid').value)||0,
        due: parseFloat(document.getElementById('invoiceDue').value)||0,
        notes: document.getElementById('invoiceNotes').value,
    };
    if(!invoice.client||!invoice.date) return alert('Client and date required');
    let list = JSON.parse(localStorage.getItem('ArvinInvoices')||'[]');
    if(idx!=='') list[idx]=invoice; else list.push(invoice);
    localStorage.setItem('ArvinInvoices', JSON.stringify(list));
    loadInvoices(); closeInvoiceModal(); showToast('Invoice saved');
}
function loadInvoices() {
    let invs = JSON.parse(localStorage.getItem('ArvinInvoices')||'[]');
    let container = document.getElementById('invoicesList'), noMsg = document.getElementById('noInvoicesMsg');
    container.innerHTML = ''; if(!invs.length) { noMsg.style.display='block'; return; } noMsg.style.display='none';
    invs.slice().reverse().forEach((inv,i)=>{
        let actualIndex = invs.length-1-i;
        let card = document.createElement('div'); card.className = 'doc-card';
        card.innerHTML = `<h3>${inv.invoiceNo} - ${inv.client}</h3><p>Date: ${inv.date} | Total: ${inv.grandTotal} | Paid: ${inv.paid} | Due: ${inv.due}</p>
            <button class="action-btn edit-btn" onclick="showInvoiceModal(${actualIndex})">Edit</button>
            <button class="action-btn del-btn" onclick="deleteInvoice(${actualIndex})">Del</button>
            <button class="action-btn" style="background:var(--success-green);color:white;" onclick="printInvoice(${actualIndex})">Print PDF</button>
            `;
        container.appendChild(card);
    });
}
function deleteInvoice(i) { 
    if(confirm('Delete this Invoice?')) { 
        let l = JSON.parse(localStorage.getItem('ArvinInvoices')); 
        l.splice(i,1); 
        localStorage.setItem('ArvinInvoices',JSON.stringify(l)); 
        loadInvoices(); 
        showToast('Deleted');
    } 
}

// ========== DELIVERY CHALLAN ==========
let deliveryItems = [];
function showDeliveryChallanModal(editIdx=null) {
    const modal = document.getElementById('deliveryModal');
    document.getElementById('editDeliveryIndex').value = editIdx!==null?editIdx:'';
    document.getElementById('deliveryDate').value = new Date().toISOString().split('T')[0];
    if(editIdx!==null){
        let dcs = JSON.parse(localStorage.getItem('ArvinDeliveries')||'[]');
        let dc = dcs[editIdx];
        document.getElementById('deliveryClient').value = dc.client||'';
        document.getElementById('deliveryAddress').value = dc.address||'';
        document.getElementById('deliveryNo').value = dc.deliveryNo;
        document.getElementById('deliveryOrderId').value = dc.orderId||'';
        document.getElementById('deliveryGatePass').value = dc.gatePass||'';
        document.getElementById('deliveryDate').value = dc.date;
        deliveryItems = dc.items?[...dc.items]:[];
    } else {
        let list = JSON.parse(localStorage.getItem('ArvinDeliveries')||'[]');
        let lastNum = list.length>0? parseInt(list[list.length-1].deliveryNo.split('-')[2]) : 100100;
        document.getElementById('deliveryNo').value = `AC-DC-${lastNum+1}`;
        document.getElementById('deliveryClient').value=''; document.getElementById('deliveryAddress').value='';
        document.getElementById('deliveryOrderId').value=''; document.getElementById('deliveryGatePass').value='';
        deliveryItems = [];
    }
    renderDeliveryItems(); modal.style.display='block';
}
function closeDeliveryModal() { document.getElementById('deliveryModal').style.display='none'; }
function addDeliveryItem() { document.getElementById('itemContext').value='delivery'; document.getElementById('itemModalTitle').innerText='Add Delivery Item'; document.getElementById('itemPriceGroup').style.display='none'; document.getElementById('itemRemarksGroup').style.display='block'; clearItemFields(); document.getElementById('itemRemarks').value=''; document.getElementById('itemModal').style.display='block'; }
function renderDeliveryItems() {
    let tbody = document.getElementById('deliveryItemsTable');
    tbody.innerHTML = '';
    if(deliveryItems.length===0) { tbody.innerHTML = '<tr><td colspan="7" class="no-data">No items</td></tr>'; return; }
    deliveryItems.forEach((it,i)=>{
        tbody.innerHTML += `<tr><td>${i+1}</td><td>${it.name}</td><td>${it.description}</td><td>${it.quantity}</td><td>${it.unit}</td><td>${it.remarks||''}</td><td><button class="action-btn edit-btn" onclick="editDeliveryItem(${i})">Edit</button><button class="action-btn del-btn" onclick="deleteDeliveryItem(${i})">Del</button></td></tr>`;
    });
}
function editDeliveryItem(i) {
    let it = deliveryItems[i];
    document.getElementById('itemContext').value='delivery';
    document.getElementById('editItemIndex').value = i;
    document.getElementById('itemName').value = it.name;
    document.getElementById('itemDescription').value = it.description;
    document.getElementById('itemQuantity').value = it.quantity;
    document.getElementById('itemUnit').value = it.unit;
    document.getElementById('itemRemarks').value = it.remarks||'';
    document.getElementById('itemPriceGroup').style.display='none'; document.getElementById('itemRemarksGroup').style.display='block';
    document.getElementById('itemModal').style.display='block';
}
function deleteDeliveryItem(i) { deliveryItems.splice(i,1); renderDeliveryItems(); }
function saveDeliveryChallan() {
    let idx = document.getElementById('editDeliveryIndex').value;
    let dc = {
        client: document.getElementById('deliveryClient').value.trim(),
        address: document.getElementById('deliveryAddress').value.trim(),
        deliveryNo: document.getElementById('deliveryNo').value,
        orderId: document.getElementById('deliveryOrderId').value,
        gatePass: document.getElementById('deliveryGatePass').value,
        date: document.getElementById('deliveryDate').value,
        items: deliveryItems
    };
    if(!dc.client||!dc.date) return alert('Required');
    let list = JSON.parse(localStorage.getItem('ArvinDeliveries')||'[]');
    if(idx!=='') list[idx]=dc; else list.push(dc);
    localStorage.setItem('ArvinDeliveries', JSON.stringify(list));
    loadDeliveryChallans(); closeDeliveryModal(); showToast('Challan saved');
}
function loadDeliveryChallans() {
    let dcs = JSON.parse(localStorage.getItem('ArvinDeliveries')||'[]');
    let container = document.getElementById('deliveryList'), noMsg = document.getElementById('noDeliveryMsg');
    container.innerHTML = ''; if(!dcs.length) { noMsg.style.display='block'; return; } noMsg.style.display='none';
    dcs.slice().reverse().forEach((dc,i)=>{
        let actualIndex = dcs.length-1-i;
        let card = document.createElement('div'); card.className = 'doc-card';
        card.innerHTML = `<h3>${dc.deliveryNo} - ${dc.client}</h3><p>Date: ${dc.date} | Order: ${dc.orderId||''} | GatePass: ${dc.gatePass||''}</p>
            <button class="action-btn edit-btn" onclick="showDeliveryChallanModal(${actualIndex})">Edit</button>
            <button class="action-btn del-btn" onclick="deleteDelivery(${actualIndex})">Del</button>
            <button class="action-btn" style="background:var(--success-green);color:white;" onclick="printDeliveryChallan(${actualIndex})">Print PDF</button>
            `;
        container.appendChild(card);
    });
}
function deleteDelivery(i) { 
    if(confirm('Delete this Delivery Challan?')) { 
        let l = JSON.parse(localStorage.getItem('ArvinDeliveries')); 
        l.splice(i,1); 
        localStorage.setItem('ArvinDeliveries',JSON.stringify(l)); 
        loadDeliveryChallans(); 
        showToast('Deleted');
    } 
}

// ========== PURCHASE ORDER ==========
let poItems = [];
function showPurchaseOrderModal(editIdx=null) {
    const modal = document.getElementById('purchaseModal');
    document.getElementById('editPOIndex').value = editIdx!==null?editIdx:'';
    document.getElementById('poDate').value = new Date().toISOString().split('T')[0];
    if(editIdx!==null){
        let pos = JSON.parse(localStorage.getItem('ArvinPO')||'[]');
        let po = pos[editIdx];
        document.getElementById('poSupplier').value = po.supplier||'';
        document.getElementById('poAddress').value = po.address||'';
        document.getElementById('poId').value = po.poId;
        document.getElementById('poDate').value = po.date;
        document.getElementById('poSubject').value = po.subject||'';
        document.getElementById('poNotes').value = po.notes||'';
        poItems = po.items?[...po.items]:[];
    } else {
        let polist = JSON.parse(localStorage.getItem('ArvinPO')||'[]');
        let lastNum = polist.length>0? parseInt(polist[polist.length-1].poId.split('-')[2]) : 100100;
        document.getElementById('poId').value = `AC-PO-${lastNum+1}`;
        document.getElementById('poSupplier').value=''; document.getElementById('poAddress').value='';
        document.getElementById('poSubject').value=''; document.getElementById('poNotes').value='';
        poItems = [];
    }
    renderPOItems(); calculatePOTotal(); modal.style.display='block';
}
function closePurchaseModal() { document.getElementById('purchaseModal').style.display='none'; }
function addPOItem() { document.getElementById('itemContext').value='po'; document.getElementById('itemModalTitle').innerText='Add PO Item'; document.getElementById('itemPriceGroup').style.display='block'; document.getElementById('itemRemarksGroup').style.display='none'; clearItemFields(); document.getElementById('itemModal').style.display='block'; }
function renderPOItems() {
    let tbody = document.getElementById('poItemsTable'), settings = JSON.parse(localStorage.getItem('ArvinSettings')||'{}'), cur = settings.currency||'‚Çπ';
    tbody.innerHTML = '';
    if(poItems.length===0) { tbody.innerHTML = '<tr><td colspan="8" class="no-data">No items</td></tr>'; return; }
    poItems.forEach((it,i)=>{
        let total = it.quantity*it.unitPrice;
        tbody.innerHTML += `<tr><td>${i+1}</td><td>${it.name}</td><td>${it.description}</td><td>${it.quantity}</td><td>${it.unit}</td><td>${cur}${it.unitPrice.toFixed(2)}</td><td>${cur}${total.toFixed(2)}</td><td><button class="action-btn edit-btn" onclick="editPOItem(${i})">Edit</button><button class="action-btn del-btn" onclick="deletePOItem(${i})">Del</button></td></tr>`;
    });
}
function editPOItem(i) {
    let it = poItems[i];
    document.getElementById('itemContext').value='po';
    document.getElementById('editItemIndex').value = i;
    document.getElementById('itemName').value = it.name;
    document.getElementById('itemDescription').value = it.description;
    document.getElementById('itemQuantity').value = it.quantity;
    document.getElementById('itemUnit').value = it.unit;
    document.getElementById('itemUnitPrice').value = it.unitPrice;
    document.getElementById('itemPriceGroup').style.display='block'; document.getElementById('itemRemarksGroup').style.display='none';
    document.getElementById('itemModal').style.display='block';
}
function deletePOItem(i) { poItems.splice(i,1); renderPOItems(); calculatePOTotal(); }
function calculatePOTotal() {
    let t = poItems.reduce((s,it)=> s + (it.quantity*it.unitPrice),0);
    document.getElementById('poGrandTotal').innerText = t.toFixed(2);
    return t;
}
function savePurchaseOrder() {
    let idx = document.getElementById('editPOIndex').value;
    let po = {
        supplier: document.getElementById('poSupplier').value.trim(),
        address: document.getElementById('poAddress').value.trim(),
        poId: document.getElementById('poId').value,
        date: document.getElementById('poDate').value,
        subject: document.getElementById('poSubject').value,
        items: poItems,
        grandTotal: parseFloat(document.getElementById('poGrandTotal').innerText)||0,
        notes: document.getElementById('poNotes').value
    };
    if(!po.supplier||!po.date) return alert('Required');
    let list = JSON.parse(localStorage.getItem('ArvinPO')||'[]');
    if(idx!=='') list[idx]=po; else list.push(po);
    localStorage.setItem('ArvinPO', JSON.stringify(list));
    loadPurchaseOrders(); closePurchaseModal(); showToast('PO saved');
}
function loadPurchaseOrders() {
    let pos = JSON.parse(localStorage.getItem('ArvinPO')||'[]');
    let container = document.getElementById('purchaseOrdersList'), noMsg = document.getElementById('noPurchaseMsg');
    container.innerHTML = ''; if(!pos.length) { noMsg.style.display='block'; return; } noMsg.style.display='none';
    pos.slice().reverse().forEach((po,i)=>{
        let actualIndex = pos.length-1-i;
        let card = document.createElement('div'); card.className = 'doc-card';
        card.innerHTML = `<h3>${po.poId} - ${po.supplier}</h3><p>Date: ${po.date} | Total: ${po.grandTotal}</p>
            <button class="action-btn edit-btn" onclick="showPurchaseOrderModal(${actualIndex})">Edit</button>
            <button class="action-btn del-btn" onclick="deletePO(${actualIndex})">Del</button>
            <button class="action-btn" style="background:var(--success-green);color:white;" onclick="printPurchaseOrder(${actualIndex})">Print PDF</button>
            `;
        container.appendChild(card);
    });
}
function deletePO(i) { 
    if(confirm('Delete this Purchase Order?')) { 
        let l = JSON.parse(localStorage.getItem('ArvinPO')); 
        l.splice(i,1); 
        localStorage.setItem('ArvinPO',JSON.stringify(l)); 
        loadPurchaseOrders(); 
        showToast('Deleted');
    } 
}

// ========== MONEY RECEIPT ==========
function showMoneyReceiptModal(editIdx=null) {
    const modal = document.getElementById('receiptModal');
    document.getElementById('editReceiptIndex').value = editIdx!==null?editIdx:'';
    document.getElementById('receiptDate').value = new Date().toISOString().split('T')[0];
    if(editIdx!==null){
        let recs = JSON.parse(localStorage.getItem('ArvinReceipts')||'[]');
        let r = recs[editIdx];
        document.getElementById('receiptClient').value = r.client||'';
        document.getElementById('receiptAddress').value = r.address||'';
        document.getElementById('receiptNo').value = r.receiptNo;
        document.getElementById('receiptDate').value = r.date;
        document.getElementById('receiptAmount').value = r.amount;
        document.getElementById('receiptWords').value = r.words||'';
        document.getElementById('receiptMode').value = r.mode||'Cash';
        document.getElementById('receiptChequeNo').value = r.chequeNo||'';
        document.getElementById('receiptBankName').value = r.bankName||'';
        document.getElementById('receiptRemarks').value = r.remarks||'';
        toggleChequeFields();
    } else {
        let reclist = JSON.parse(localStorage.getItem('ArvinReceipts')||'[]');
        let lastNum = reclist.length>0? parseInt(reclist[reclist.length-1].receiptNo.split('-')[2]) : 100100;
        document.getElementById('receiptNo').value = `AC-MR-${lastNum+1}`;
        document.getElementById('receiptClient').value=''; document.getElementById('receiptAddress').value='';
        document.getElementById('receiptAmount').value=''; document.getElementById('receiptWords').value='';
        document.getElementById('receiptMode').value='Cash'; document.getElementById('receiptChequeNo').value=''; document.getElementById('receiptBankName').value=''; document.getElementById('receiptRemarks').value='';
    }
    toggleChequeFields(); modal.style.display='block';
}
function closeReceiptModal() { document.getElementById('receiptModal').style.display='none'; }
function toggleChequeFields() {
    let mode = document.getElementById('receiptMode').value;
    document.getElementById('chequeFields').style.display = (mode==='Cheque')?'block':'none';
}
function updateAmountWords() {
    let amt = parseFloat(document.getElementById('receiptAmount').value)||0;
    document.getElementById('receiptWords').value = numberToWords(amt);
}
function saveMoneyReceipt() {
    let idx = document.getElementById('editReceiptIndex').value;
    let rec = {
        client: document.getElementById('receiptClient').value.trim(),
        address: document.getElementById('receiptAddress').value.trim(),
        receiptNo: document.getElementById('receiptNo').value,
        date: document.getElementById('receiptDate').value,
        amount: parseFloat(document.getElementById('receiptAmount').value)||0,
        words: document.getElementById('receiptWords').value,
        mode: document.getElementById('receiptMode').value,
        chequeNo: document.getElementById('receiptChequeNo').value,
        bankName: document.getElementById('receiptBankName').value,
        remarks: document.getElementById('receiptRemarks').value
    };
    if(!rec.client||!rec.date||!rec.amount) return alert('Client, date and amount required');
    let list = JSON.parse(localStorage.getItem('ArvinReceipts')||'[]');
    if(idx!=='') list[idx]=rec; else list.push(rec);
    localStorage.setItem('ArvinReceipts', JSON.stringify(list));
    loadMoneyReceipts(); closeReceiptModal(); showToast('Receipt saved');
}
function loadMoneyReceipts() {
    let recs = JSON.parse(localStorage.getItem('ArvinReceipts')||'[]');
    let container = document.getElementById('receiptList'), noMsg = document.getElementById('noReceiptMsg');
    container.innerHTML = ''; if(!recs.length) { noMsg.style.display='block'; return; } noMsg.style.display='none';
    recs.slice().reverse().forEach((r,i)=>{
        let actualIndex = recs.length-1-i;
        let card = document.createElement('div'); card.className = 'doc-card';
        card.innerHTML = `<h3>${r.receiptNo} - ${r.client}</h3><p>Date: ${r.date} | Amount: ${r.amount} | Mode: ${r.mode}</p>
            <button class="action-btn edit-btn" onclick="showMoneyReceiptModal(${actualIndex})">Edit</button>
            <button class="action-btn del-btn" onclick="deleteReceipt(${actualIndex})">Del</button>
            <button class="action-btn" style="background:var(--success-green);color:white;" onclick="printMoneyReceipt(${actualIndex})">Print PDF</button>
            `;
        container.appendChild(card);
    });
}
function deleteReceipt(i) { 
    if(confirm('Delete this Money Receipt?')) { 
        let l = JSON.parse(localStorage.getItem('ArvinReceipts')); 
        l.splice(i,1); 
        localStorage.setItem('ArvinReceipts',JSON.stringify(l)); 
        loadMoneyReceipts(); 
        showToast('Deleted');
    } 
}

// ========== LETTER ==========
function showLetterModal(editIdx=null) {
    const modal = document.getElementById('letterModal');
    document.getElementById('editLetterIndex').value = editIdx!==null?editIdx:'';
    document.getElementById('letterDate').value = new Date().toISOString().split('T')[0];
    if(editIdx!==null){
        let lets = JSON.parse(localStorage.getItem('ArvinLetters')||'[]');
        let l = lets[editIdx];
        document.getElementById('letterTitle').value = l.title||'';
        document.getElementById('letterDate').value = l.date;
        document.getElementById('letterRef').value = l.ref||'';
        document.getElementById('letterContent').value = l.content||'';
    } else {
        document.getElementById('letterTitle').value=''; document.getElementById('letterRef').value=''; document.getElementById('letterContent').value='';
    }
    modal.style.display='block';
}
function closeLetterModal() { document.getElementById('letterModal').style.display='none'; }
function saveLetter() {
    let idx = document.getElementById('editLetterIndex').value;
    let letter = {
        title: document.getElementById('letterTitle').value.trim(),
        date: document.getElementById('letterDate').value,
        ref: document.getElementById('letterRef').value,
        content: document.getElementById('letterContent').value
    };
    if(!letter.title||!letter.date||!letter.content) return alert('Title, date and content required');
    let list = JSON.parse(localStorage.getItem('ArvinLetters')||'[]');
    if(idx!=='') list[idx]=letter; else list.push(letter);
    localStorage.setItem('ArvinLetters', JSON.stringify(list));
    loadLetters(); closeLetterModal(); showToast('Letter saved');
}
function loadLetters() {
    let lets = JSON.parse(localStorage.getItem('ArvinLetters')||'[]');
    let container = document.getElementById('lettersList'), noMsg = document.getElementById('noLettersMsg');
    container.innerHTML = ''; if(!lets.length) { noMsg.style.display='block'; return; } noMsg.style.display='none';
    lets.slice().reverse().forEach((l,i)=>{
        let actualIndex = lets.length-1-i;
        let card = document.createElement('div'); card.className = 'doc-card';
        card.innerHTML = `<h3>${l.title}</h3><p><small>${l.date} | Ref: ${l.ref||'N/A'}</small></p><p style="white-space:pre-wrap; text-align:justify;">${l.content.substring(0,100)}...</p>
            <button class="action-btn edit-btn" onclick="showLetterModal(${actualIndex})">Edit</button>
            <button class="action-btn del-btn" onclick="deleteLetter(${actualIndex})">Del</button>
            <button class="action-btn" style="background:var(--success-green);color:white;" onclick="printLetter(${actualIndex})">Print PDF</button>
            `;
        container.appendChild(card);
    });
}
function deleteLetter(i) { 
    if(confirm('Delete this Letter?')) { 
        let l = JSON.parse(localStorage.getItem('ArvinLetters')); 
        l.splice(i,1); 
        localStorage.setItem('ArvinLetters',JSON.stringify(l)); 
        loadLetters(); 
        showToast('Deleted');
    } 
}

// ========== COMMON ITEM SAVE ==========
function clearItemFields() {
    document.getElementById('itemName').value='';
    document.getElementById('itemDescription').value='';
    document.getElementById('itemQuantity').value=1;
    document.getElementById('itemUnit').value='';
    if(document.getElementById('itemUnitPrice')) document.getElementById('itemUnitPrice').value=0;
    if(document.getElementById('itemRemarks')) document.getElementById('itemRemarks').value='';
    document.getElementById('editItemIndex').value='';
}
function saveItem() {
    let ctx = document.getElementById('itemContext').value;
    let idx = document.getElementById('editItemIndex').value;
    let item = {
        name: document.getElementById('itemName').value.trim(),
        description: document.getElementById('itemDescription').value.trim(),
        quantity: parseFloat(document.getElementById('itemQuantity').value)||1,
        unit: document.getElementById('itemUnit').value.trim()
    };
    if(ctx==='invoice'||ctx==='po'||ctx==='quotation') {
        item.unitPrice = parseFloat(document.getElementById('itemUnitPrice').value)||0;
    }
    if(ctx==='delivery') {
        item.remarks = document.getElementById('itemRemarks').value.trim();
    }
    if(!item.name) return alert('Item name required');
    if(ctx==='invoice') { if(idx!=='') invoiceItems[idx] = item; else invoiceItems.push(item); renderInvoiceItems(); calculateInvoiceTotal(); }
    else if(ctx==='po') { if(idx!=='') poItems[idx] = item; else poItems.push(item); renderPOItems(); calculatePOTotal(); }
    else if(ctx==='delivery') { if(idx!=='') deliveryItems[idx] = item; else deliveryItems.push(item); renderDeliveryItems(); }
    else if(ctx==='quotation') { 
        if(!item.unitPrice) item.unitPrice = 0;
        if(idx!=='') quotationItems[idx] = item; else quotationItems.push(item); 
        renderQuotationItems(); calculateQuotationGrandTotal(); 
    }
    closeItemModal();
}
function closeItemModal() { document.getElementById('itemModal').style.display='none'; }

// ========== PDF & PRINT HELPERS ==========
function formatDateToOrdinal(dateStr) {
    if (!dateStr) return '';
    let d = new Date(dateStr + 'T12:00:00');
    if (isNaN(d.getTime())) return dateStr;
    let day = d.getDate();
    let month = d.toLocaleString('default', { month: 'short' });
    let year = d.getFullYear();
    let suffix = 'th';
    if (day === 1 || day === 21 || day === 31) suffix = 'st';
    else if (day === 2 || day === 22) suffix = 'nd';
    else if (day === 3 || day === 23) suffix = 'rd';
    return `${day}${suffix} ${month}, ${year}`;
}

function numberToWords(amount) {
    const ones = ['Zero', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
    const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
    let num = Math.floor(amount), words = '';
    if (Math.floor(num / 10000000) > 0) { words += ones[Math.floor(num / 10000000)] + ' Crore '; num %= 10000000; }
    if (Math.floor(num / 100000) > 0) { words += ones[Math.floor(num / 100000)] + ' Lakh '; num %= 100000; }
    if (Math.floor(num / 1000) > 0) { words += ones[Math.floor(num / 1000)] + ' Thousand '; num %= 1000; }
    if (Math.floor(num / 100) > 0) { words += ones[Math.floor(num / 100)] + ' Hundred '; num %= 100; }
    if (num > 0) { if (num < 20) words += ones[num]; else { words += tens[Math.floor(num / 10)] + (num % 10 !== 0 ? ' ' + ones[num % 10] : ''); } }
    words += ' Only';
    return words;
}

function getQuotationHTML(index) { 
    let quotes = JSON.parse(localStorage.getItem('ArvinQuotations') || '[]'), q = quotes[index];
    let s = JSON.parse(localStorage.getItem('ArvinSettings') || '{}'), currency = s.currency || '‚Çπ';
    let subtotal = q.items.reduce((sum,it)=> sum + it.quantity*it.unitPrice,0);
    let vat = subtotal * (q.vatPercent || 0) / 100;
    let ait = subtotal * (q.aitPercent || 0) / 100;
    let grand = subtotal + vat + ait;
    
    let rows = q.items.map((it,i)=> `<tr><td style="border:1px solid black;padding:5px;text-align:center;">${i+1}</td><td style="border:1px solid black;padding:5px;text-align:left;">${it.name}</td><td style="border:1px solid black;padding:5px;text-align:left;">${it.description}</td><td style="border:1px solid black;padding:5px;text-align:center;">${it.quantity}</td><td style="border:1px solid black;padding:5px;text-align:center;">${it.unit}</td><td style="border:1px solid black;padding:5px;text-align:center;">${currency}${it.unitPrice.toFixed(2)}</td><td style="border:1px solid black;padding:5px;text-align:center;">${currency}${(it.quantity*it.unitPrice).toFixed(2)}</td></tr>`).join('');
    let formattedDate = formatDateToOrdinal(q.date);
    return `
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:12px;">
            <div><strong>To,</strong><br>${q.client}<br>${q.address.replace(/\n/g,'<br>')}</div>
            <div style="text-align:right;"><strong>Date:</strong> ${formattedDate}<br><strong>ID:</strong> ${q.id}<br><strong>Ref:</strong> ${q.reference||'N/A'}</div>
        </div>
        <div style="margin-bottom:10px; font-weight:bold; font-size:12px;">Subject: ${q.subject}</div>
        <table style="width:100%; border-collapse:collapse; font-size:11px;">
            <thead><tr style="background:#f2f2f2;"><th style="border:1px solid black;padding:5px;text-align:center;">SL</th><th style="border:1px solid black;padding:5px;text-align:center;">Item</th><th style="border:1px solid black;padding:5px;text-align:center;">Description</th><th style="border:1px solid black;padding:5px;text-align:center;">Qty</th><th style="border:1px solid black;padding:5px;text-align:center;">Unit</th><th style="border:1px solid black;padding:5px;text-align:center;">Price</th><th style="border:1px solid black;padding:5px;text-align:center;">Total</th></tr></thead>
            <tbody>
                ${rows}
                <tr><td colspan="6" style="border:1px solid black;padding:5px;text-align:right;">Subtotal</td><td style="border:1px solid black;padding:5px;text-align:center;">${currency}${subtotal.toFixed(2)}</td></tr>
                ${vat > 0 ? `<tr><td colspan="6" style="border:1px solid black;padding:5px;text-align:right;">VAT (${q.vatPercent}%)</td><td style="border:1px solid black;padding:5px;text-align:center;">${currency}${vat.toFixed(2)}</td></tr>` : ''}
                ${ait > 0 ? `<tr><td colspan="6" style="border:1px solid black;padding:5px;text-align:right;">AIT (${q.aitPercent}%)</td><td style="border:1px solid black;padding:5px;text-align:center;">${currency}${ait.toFixed(2)}</td></tr>` : ''}
                <tr><td colspan="6" style="border:1px solid black;padding:5px;text-align:right;font-weight:bold;">Grand Total</td><td style="border:1px solid black;padding:5px;text-align:center;font-weight:bold;">${currency}${grand.toFixed(2)}</td></tr>
            </tbody>
        </table>
        <div style="margin-top:10px; font-size:11px;"><strong>Words:</strong> ${numberToWords(grand)}</div>
        <div style="margin-top:15px; font-size:11px; white-space:pre-wrap;"><strong>Terms & Conditions:</strong><br>${s.termsQuo||'Standard Terms Apply'}</div>
        <div class="signature-wrapper" style="margin-top:30px; text-align:right;">
            ${s.signImg ? `<img src="${s.signImg}" style="height:40px; display:inline-block;"><br>` : ''}
            <div style="width:200px; height:1px; background:black; margin:2px 0 0 auto;"></div>
            <span style="font-size:11px;"><strong>For ${s.name || 'Arvin Controls,'}</strong><br><strong>${s.signName||''}</strong><br>${s.signDes||''}</span>
        </div>`;
}

function printQuotation(index) {
    let s = JSON.parse(localStorage.getItem('ArvinSettings') || '{}');
    document.getElementById('print-comp-name').innerText = s.name || 'Arvin Controls';
    document.getElementById('print-comp-address').innerText = s.address || '';
    document.getElementById('print-comp-contact').innerText = `Mobile : ${s.mobile||''} | Email : ${s.email||''} | Website : ${s.website||''}`;
    document.getElementById('pdf-title-val').innerText = 'QUOTATION';
    document.getElementById('pdf-content-val').innerHTML = getQuotationHTML(index);
    document.getElementById('print-footer-slogan').innerText = s.slogan || '';
    setTimeout(()=>window.print(), 300);
}

function getInvoiceHTML(index) {
    let invs = JSON.parse(localStorage.getItem('ArvinInvoices')||'[]'), inv = invs[index];
    let s = JSON.parse(localStorage.getItem('ArvinSettings')||'{}'), cur = s.currency||'‚Çπ';
    let rows = inv.items.map((it,i)=> `<tr><td style="border:1px solid black;padding:5px;text-align:center;">${i+1}</td><td style="border:1px solid black;padding:5px;text-align:left;">${it.name}</td><td style="border:1px solid black;padding:5px;text-align:left;">${it.description}</td><td style="border:1px solid black;padding:5px;text-align:center;">${it.quantity}</td><td style="border:1px solid black;padding:5px;text-align:center;">${it.unit}</td><td style="border:1px solid black;padding:5px;text-align:center;">${cur}${it.unitPrice.toFixed(2)}</td><td style="border:1px solid black;padding:5px;text-align:center;">${cur}${(it.quantity*it.unitPrice).toFixed(2)}</td></tr>`).join('');
    let formattedDate = formatDateToOrdinal(inv.date);
    return `<div style="display:flex; justify-content:space-between; margin-bottom:10px;"><div><strong>Bill To:</strong><br>${inv.client}<br>${inv.address.replace(/\n/g,'<br>')}</div><div style="text-align:right;"><strong>Invoice:</strong> ${inv.invoiceNo}<br><strong>Date:</strong> ${formattedDate}<br><strong>Order:</strong> ${inv.orderId||''}</div></div>
    <div style="margin-bottom:10px;"><strong>Subject:</strong> ${inv.subject||''}</div>
    <table style="width:100%; border-collapse:collapse; font-size:11px;"><thead><tr style="background:#f2f2f2;"><th style="border:1px solid black;padding:5px;text-align:center;">SL</th><th style="border:1px solid black;padding:5px;text-align:center;">Item</th><th style="border:1px solid black;padding:5px;text-align:center;">Description</th><th style="border:1px solid black;padding:5px;text-align:center;">Qty</th><th style="border:1px solid black;padding:5px;text-align:center;">Unit</th><th style="border:1px solid black;padding:5px;text-align:center;">Price</th><th style="border:1px solid black;padding:5px;text-align:center;">Total</th></tr></thead>
    <tbody>${rows}<tr><td colspan="6" style="border:1px solid black;padding:5px;text-align:right;">Subtotal</td><td style="border:1px solid black;padding:5px;text-align:center;">${cur}${inv.grandTotal.toFixed(2)}</td></tr>
    <tr><td colspan="6" style="border:1px solid black;padding:5px;text-align:right;">Paid Amount</td><td style="border:1px solid black;padding:5px;text-align:center;">${cur}${inv.paid.toFixed(2)}</td></tr>
    <tr><td colspan="6" style="border:1px solid black;padding:5px;text-align:right; font-weight:bold;">Due Amount</td><td style="border:1px solid black;padding:5px;text-align:center; font-weight:bold;">${cur}${inv.due.toFixed(2)}</td></tr>
    </tbody></table>
    <div style="margin-top:10px; font-size:11px;"><strong>Words (Due Amount):</strong> ${numberToWords(inv.due)}</div>
    <div style="margin-top:15px; font-size:11px; white-space:pre-wrap;"><strong>Terms & Conditions:</strong><br>${s.termsInv||'Standard Terms'}</div>
    <div class="signature-wrapper" style="margin-top:30px; text-align:right;">${s.signImg?`<img src="${s.signImg}" style="height:40px; display:inline-block;"><br>`:''}<div style="width:200px; height:1px; background:black; margin:2px 0 0 auto;"></div><span><strong>For ${s.name || 'Arvin Controls'}</strong><br><strong>${s.signName||''}</strong><br>${s.signDes||''}</span></div>`;
}
function printInvoice(index){ let s=JSON.parse(localStorage.getItem('ArvinSettings')||'{}'); document.getElementById('print-comp-name').innerText=s.name||'Arvin Controls'; document.getElementById('print-comp-address').innerText=s.address||''; document.getElementById('print-comp-contact').innerText=`Mobile : ${s.mobile||''} | Email : ${s.email||''} | Website : ${s.website||''}`; document.getElementById('pdf-title-val').innerText='INVOICE'; document.getElementById('pdf-content-val').innerHTML=getInvoiceHTML(index); document.getElementById('print-footer-slogan').innerText=s.slogan||''; setTimeout(()=>window.print(),300); }

function getDeliveryHTML(index){ 
    let dcs=JSON.parse(localStorage.getItem('ArvinDeliveries')||'[]'),dc=dcs[index]; 
    let s=JSON.parse(localStorage.getItem('ArvinSettings')||'{}'); 
    let rows=dc.items.map((it,i)=>`<tr><td style="border:1px solid black;padding:5px;text-align:center;">${i+1}</td><td style="border:1px solid black;padding:5px;text-align:left;">${it.name}</td><td style="border:1px solid black;padding:5px;text-align:left;">${it.description}</td><td style="border:1px solid black;padding:5px;text-align:center;">${it.quantity}</td><td style="border:1px solid black;padding:5px;text-align:center;">${it.unit}</td><td style="border:1px solid black;padding:5px;text-align:center;">${it.remarks||''}</td></tr>`).join(''); 
    let formattedDate = formatDateToOrdinal(dc.date);
    return `<div style="display:flex; justify-content:space-between; margin-bottom:10px;"><div><strong>Deliver To:</strong><br>${dc.client}<br>${dc.address.replace(/\n/g,'<br>')}</div><div style="text-align:right;"><strong>Challan No:</strong> ${dc.deliveryNo}<br><strong>Date:</strong> ${formattedDate}<br><strong>Order:</strong> ${dc.orderId||''}<br><strong>Gate Pass:</strong> ${dc.gatePass||''}</div></div>
    <table style="width:100%; border-collapse:collapse; font-size:11px; margin-top:10px;"><thead><tr style="background:#f2f2f2;"><th style="border:1px solid black;padding:5px;text-align:center;">SL</th><th style="border:1px solid black;padding:5px;text-align:center;">Item</th><th style="border:1px solid black;padding:5px;text-align:center;">Description</th><th style="border:1px solid black;padding:5px;text-align:center;">Qty</th><th style="border:1px solid black;padding:5px;text-align:center;">Unit</th><th style="border:1px solid black;padding:5px;text-align:center;">Remarks</th></tr></thead>
    <tbody>${rows}</tbody></table>
    <div style="margin-top:15px; font-size:11px; white-space:pre-wrap;"><strong>Terms & Conditions:</strong><br>${s.termsChallan||'Standard Challan Terms'}</div>
    <div style="display:flex; justify-content:space-between; margin-top:30px;">
        <div style="text-align:left;">
            <strong>Received By</strong><br>
            <span style="display:inline-block; width:200px; border-bottom:1px solid black; margin-top:15px;"></span><br>
            <span style="font-size:11px;">Signature & Date</span>
        </div>
        <div style="text-align:right;">
            ${s.signImg?`<img src="${s.signImg}" style="height:40px; display:inline-block;"><br>`:''}
            <div style="width:200px; height:1px; background:black; margin:2px 0 0 auto;"></div>
            <span><strong>For ${s.name || 'Arvin Controls'}</strong><br><strong>${s.signName||''}</strong><br>${s.signDes||''}</span>
        </div>
    </div>`; 
}
function printDeliveryChallan(index){ let s=JSON.parse(localStorage.getItem('ArvinSettings')||'{}'); document.getElementById('print-comp-name').innerText=s.name||'Arvin Controls'; document.getElementById('print-comp-address').innerText=s.address||''; document.getElementById('print-comp-contact').innerText=`Mobile : ${s.mobile||''} | Email : ${s.email||''} | Website : ${s.website||''}`; document.getElementById('pdf-title-val').innerText='DELIVERY CHALLAN'; document.getElementById('pdf-content-val').innerHTML=getDeliveryHTML(index); document.getElementById('print-footer-slogan').innerText=s.slogan||''; setTimeout(()=>window.print(),300); }

function getPurchaseHTML(index){ 
    let pos=JSON.parse(localStorage.getItem('ArvinPO')||'[]'),po=pos[index]; 
    let s=JSON.parse(localStorage.getItem('ArvinSettings')||'{}'),cur=s.currency||'‚Çπ'; 
    let rows=po.items.map((it,i)=>`<tr><td style="border:1px solid black;padding:5px;text-align:center;">${i+1}</td><td style="border:1px solid black;padding:5px;text-align:left;">${it.name}</td><td style="border:1px solid black;padding:5px;text-align:left;">${it.description}</td><td style="border:1px solid black;padding:5px;text-align:center;">${it.quantity}</td><td style="border:1px solid black;padding:5px;text-align:center;">${it.unit}</td><td style="border:1px solid black;padding:5px;text-align:center;">${cur}${it.unitPrice.toFixed(2)}</td><td style="border:1px solid black;padding:5px;text-align:center;">${cur}${(it.quantity*it.unitPrice).toFixed(2)}</td></tr>`).join(''); 
    let formattedDate = formatDateToOrdinal(po.date);
    return `<div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <div><strong>To,</strong><br>${po.supplier}<br>${po.address.replace(/\n/g,'<br>')}</div>
                <div style="text-align:right;"><strong>PO No:</strong> ${po.poId}<br><strong>Date:</strong> ${formattedDate}</div>
            </div>
    <div style="margin-bottom:10px;"><strong>Subject:</strong> ${po.subject||''}</div>
    <table style="width:100%; border-collapse:collapse; font-size:11px;"><thead><tr style="background:#f2f2f2;"><th style="border:1px solid black;padding:5px;text-align:center;">SL</th><th style="border:1px solid black;padding:5px;text-align:center;">Item</th><th style="border:1px solid black;padding:5px;text-align:center;">Description</th><th style="border:1px solid black;padding:5px;text-align:center;">Qty</th><th style="border:1px solid black;padding:5px;text-align:center;">Unit</th><th style="border:1px solid black;padding:5px;text-align:center;">Unit Price</th><th style="border:1px solid black;padding:5px;text-align:center;">Total</th></tr></thead>
    <tbody>${rows}<tr><td colspan="6" style="border:1px solid black;padding:5px;text-align:right;font-weight:bold;">Grand Total</td><td style="border:1px solid black;padding:5px;text-align:center;font-weight:bold;">${cur}${po.grandTotal.toFixed(2)}</td></tr></tbody></table>
    <div style="margin-top:10px; font-size:11px;"><strong>Words:</strong> ${numberToWords(po.grandTotal)}</div>
    <div style="margin-top:15px; font-size:11px; white-space:pre-wrap;"><strong>Terms & Conditions:</strong><br>${s.termsPO||po.notes||'Standard PO Terms'}</div>
    <div class="signature-wrapper" style="margin-top:30px; text-align:right;">${s.signImg?`<img src="${s.signImg}" style="height:40px; display:inline-block;"><br>`:''}<div style="width:200px; height:1px; background:black; margin:2px 0 0 auto;"></div><span><strong>For ${s.name || 'Arvin Controls'}</strong><br><strong>${s.signName||''}</strong><br>${s.signDes||''}</span></div>`; 
}
function printPurchaseOrder(index){ let s=JSON.parse(localStorage.getItem('ArvinSettings')||'{}'); document.getElementById('print-comp-name').innerText=s.name||'Arvin Controls'; document.getElementById('print-comp-address').innerText=s.address||''; document.getElementById('print-comp-contact').innerText=`Mobile : ${s.mobile||''} | Email : ${s.email||''} | Website : ${s.website||''}`; document.getElementById('pdf-title-val').innerText='PURCHASE ORDER'; document.getElementById('pdf-content-val').innerHTML=getPurchaseHTML(index); document.getElementById('print-footer-slogan').innerText=s.slogan||''; setTimeout(()=>window.print(),300); }

function getReceiptHTML(index) {
    let recs = JSON.parse(localStorage.getItem('ArvinReceipts') || '[]'), r = recs[index];
    let s = JSON.parse(localStorage.getItem('ArvinSettings') || '{}'), cur = s.currency || '‚Çπ';
    let formattedDate = formatDateToOrdinal(r.date);
    return `
        <div style="border:2px solid #cc0000; padding:20px; border-radius:6px; background:#fff; box-shadow: 0 0 12px rgba(0,0,0,0.05);">
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #cc0000; padding-bottom:10px; margin-bottom:20px;">
                <h2 style="margin:0; color:#cc0000; font-size:26px; font-weight:800;">MONEY RECEIPT</h2>
                <div style="text-align:right;">
                    <span style="display:block; font-size:14px;"><strong>Receipt No:</strong> ${r.receiptNo}</span>
                    <span style="display:block; font-size:14px;"><strong>Date:</strong> ${formattedDate}</span>
                </div>
            </div>
            <div style="margin-bottom:15px; font-size:14px;">
                <strong style="background:#f2f2f2; padding:8px 12px; display:block; border-radius:4px;">Received with thanks from</strong>
                <div style="padding:12px; border:1px solid #ddd; border-radius:4px; margin-top:5px;">
                    <span style="font-size:16px; font-weight:bold;">${r.client}</span><br>
                    <span style="font-size:13px;">${r.address.replace(/\n/g,', ')}</span>
                </div>
            </div>
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <div style="width:60%;">
                    <strong>Amount in Words</strong>
                    <div style="border-bottom:1px solid #aaa; padding:8px 0; font-size:14px; text-transform:capitalize;">${r.words}</div>
                </div>
                <div style="width:35%; text-align:right;">
                    <strong>Amount</strong>
                    <div style="font-size:22px; font-weight:bold; color:#cc0000;">${cur} ${parseFloat(r.amount).toFixed(2)}</div>
                </div>
            </div>
            <div style="display:flex; flex-wrap:wrap; gap:15px; margin-bottom:20px; background:#fafafa; padding:12px; border-radius:6px;">
                <div><strong>Payment Mode:</strong> ${r.mode}</div>
                ${r.mode === 'Cheque' ? `<div><strong>Cheque No:</strong> ${r.chequeNo || ''}</div><div><strong>Bank:</strong> ${r.bankName || ''}</div>` : ''}
                <div><strong>Remarks:</strong> ${r.remarks || '‚Äî'}</div>
            </div>
            <div style="display:flex; justify-content:space-between; margin-top:30px; padding-top:15px; border-top:1px dashed #aaa;">
                <div style="text-align:left; width:45%;">
                    <div style="margin-bottom:4px;"><strong>Receiver's Signature</strong></div>
                    <div style="border-bottom:1px solid #000; width:200px; margin-top:15px;"></div>
                </div>
                <div style="text-align:right;">
                    ${s.signImg ? `<img src="${s.signImg}" style="height:45px; margin-bottom:5px;"><br>` : ''}
                    <div style="width:200px; height:1px; background:black; margin:2px 0 0 auto;"></div>
                    <span style="font-size:12px;"><strong>For ${s.name || 'Arvin Controls'}</strong><br>${s.signName || 'Authorized Signatory'}<br>${s.signDes || ''}</span>
                </div>
            </div>
            <div style="margin-top:20px; text-align:center; color:#666; font-size:11px; border-top:1px solid #eee; padding-top:8px;">
                This is a software generated receipt & valid without signature
            </div>
        </div>
    `;
}

function printMoneyReceipt(index) {
    let s = JSON.parse(localStorage.getItem('ArvinSettings') || '{}');
    document.getElementById('print-comp-name').innerText = s.name || 'Arvin Controls';
    document.getElementById('print-comp-address').innerText = s.address || '';
    document.getElementById('print-comp-contact').innerText = `Mobile : ${s.mobile || ''} | Email : ${s.email || ''} | Website : ${s.website || ''}`;
    document.getElementById('pdf-title-val').innerText = 'MONEY RECEIPT';
    document.getElementById('pdf-content-val').innerHTML = getReceiptHTML(index);
    document.getElementById('print-footer-slogan').innerText = s.slogan || '';
    setTimeout(() => window.print(), 300);
}

function getLetterHTML(index){ 
    let lets=JSON.parse(localStorage.getItem('ArvinLetters')||'[]'),l=lets[index]; 
    let s=JSON.parse(localStorage.getItem('ArvinSettings')||'{}'); 
    let formattedDate = formatDateToOrdinal(l.date);
    return `<div style="text-align:right;"><strong>Date:</strong> ${formattedDate}<br><strong>Ref:</strong> ${l.ref||''}</div>
    <div style="margin-top:20px; white-space:pre-wrap; text-align:justify;">${l.content}</div>
    <div class="signature-wrapper" style="margin-top:40px; text-align:right;">
        ${s.signImg?`<img src="${s.signImg}" style="height:40px; display:inline-block;"><br>`:''}
        <div style="width:200px; height:1px; background:black; margin:2px 0 0 auto;"></div>
        <span><strong>For ${s.name || 'Arvin Controls'}</strong><br><strong>${s.signName||''}</strong><br>${s.signDes||''}</span>
    </div>`; 
}
function printLetter(index){ 
    let s=JSON.parse(localStorage.getItem('ArvinSettings')||'{}'); 
    document.getElementById('print-comp-name').innerText=s.name||'Arvin Controls'; 
    document.getElementById('print-comp-address').innerText=s.address||''; 
    document.getElementById('print-comp-contact').innerText=`Mobile : ${s.mobile||''} | Email : ${s.email||''} | Website : ${s.website||''}`; 
    let letter = JSON.parse(localStorage.getItem('ArvinLetters')||'[]')[index]; 
    document.getElementById('pdf-title-val').innerText = letter.title || 'LETTER'; 
    document.getElementById('pdf-content-val').innerHTML = getLetterHTML(index); 
    document.getElementById('print-footer-slogan').innerText=s.slogan||''; 
    setTimeout(()=>window.print(),300); 
}

// ========== SETTINGS & UTILS ==========
function getBase64(file) { return new Promise((resolve, reject) => { const r=new FileReader(); r.readAsDataURL(file); r.onload=()=>resolve(r.result); r.onerror=e=>reject(e); }); }
function previewFile(id, pid) { let f=document.getElementById(id).files[0]; if(f){ let r=new FileReader(); r.onload=e=>{let m=document.getElementById(pid); m.src=e.target.result; m.style.display='block';}; r.readAsDataURL(f); } }

async function saveSettings() {
    let settings = {
        name: document.getElementById('setCompanyName').value,
        slogan: document.getElementById('setSlogan').value,
        address: document.getElementById('setAddress').value,
        email: document.getElementById('setEmail').value,
        mobile: document.getElementById('setMobile').value,
        website: document.getElementById('setWebsite').value,
        currency: document.getElementById('setCurrency').value,
        signName: document.getElementById('setSignatoryName').value,
        signDes: document.getElementById('setSignatoryDesignation').value,
        termsQuo: document.getElementById('termsQuotation').value,
        termsInv: document.getElementById('termsInvoice').value,
        termsChallan: document.getElementById('termsChallan').value,
        termsPO: document.getElementById('termsPO').value,
        logo: document.getElementById('logoPreview').src,
        signImg: document.getElementById('signPreview').src
    };
    localStorage.setItem('ArvinSettings', JSON.stringify(settings));
    showToast('Settings Saved');
}
function loadSettings() {
    let s = JSON.parse(localStorage.getItem('ArvinSettings') || '{}');
    if(s.name){
        document.getElementById('setCompanyName').value = s.name || '';
        document.getElementById('setSlogan').value = s.slogan || '';
        document.getElementById('setAddress').value = s.address || '';
        document.getElementById('setEmail').value = s.email || '';
        document.getElementById('setMobile').value = s.mobile || '';
        document.getElementById('setWebsite').value = s.website || '';
        document.getElementById('setCurrency').value = s.currency || '‚Çπ';
        document.getElementById('setSignatoryName').value = s.signName || '';
        document.getElementById('setSignatoryDesignation').value = s.signDes || '';
        document.getElementById('termsQuotation').value = s.termsQuo || '';
        document.getElementById('termsInvoice').value = s.termsInv || '';
        document.getElementById('termsChallan').value = s.termsChallan || '';
        document.getElementById('termsPO').value = s.termsPO || '';
        if(s.logo) { document.getElementById('logoPreview').src=s.logo; document.getElementById('logoPreview').style.display='block'; }
        if(s.signImg) { document.getElementById('signPreview').src=s.signImg; document.getElementById('signPreview').style.display='block'; }
    } else {
        document.getElementById('setCurrency').value = '‚Çπ';
    }
}
function showToast(m) {
    let t = document.createElement('div'); t.className='toast-notification'; t.innerText=m; document.body.appendChild(t);
    setTimeout(()=>t.remove(), 3000);
}

window.onclick = e => {
    if(e.target.className==='modal') e.target.style.display='none';
};
</script>

</body>
</html>